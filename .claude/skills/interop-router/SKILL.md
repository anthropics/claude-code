---
name: Interop Router
description: >
  自動判斷當前任務是否交給外部 AI CLI（Codex 或 Gemini）更有效率，
  並在獲得一次性同意後，優先透過 /interop-broker 進行安全封裝、執行與最小變更落地；
  若未獲得同意，則僅提出建議與可複製命令，不會直接執行。
---

# Interop Router（自動判斷是否交給 Codex / Gemini）

## 觸發時機（任一成立即可）
- 大型重構 / 大量檔案改動、樣板生成、或明顯可從多模型比對中受益
- 需要結構化輸出（JSON/差異摘要），且外部 CLI 輸出更好標準化
- 之前嘗試出現超時/低信心；或使用者明示「交叉比對/比較不同模型」
- 需要快速產生多個候選方案，再由 Claude 做評審/合成

## 決策規則（評分）
- 收益（0.0–0.6）：外部 CLI 是否能更快或更穩產出結果
- 成本（-0.3–0.0）：額外封裝/正規化/審查成本
- 風險（-0.3–0.0）：權限、寫入、機密資料外洩風險（預設唯讀可降低）
- 旗標判斷：
  - 專案層 `.claude/flags/auto-interop.json` 若為 `{ "enabled": true }` → 視為本專案已允許一次性自動交接（首次仍簡要提示）。
  - 否則若使用者層 `~/.claude/flags/auto-interop.json` 為 true → 提出建議並詢問是否沿用到本專案。
- 綜合評分與旗標：若總分 ≥ 0.4 → 建議交由外部；若 ≥ 0.6 且旗標允許（或已口頭同意一次性授權）→ 可直接呼叫 /interop-broker。

## 執行步驟
1. 先以唯讀方式封裝上下文：僅提取必要檔案片段與 `git diff`，移除機密（.env/金鑰）
2. 若本工作階段已獲得一次性授權（由使用者先前明示同意）：
   - 直接呼叫 `/interop-broker`，由其決定 Router/Broker/Cascade，完成執行、審查與最小落地
3. 若尚未同意：
   - 提出建議與命令草案（/handoff-codex 或 /handoff-gemini），並請一次性同意後再執行
4. 所有結果在落地前一律跑 `pr-review-toolkit` 與 `security-guidance`；僅產生最小可回復變更（apply_patch 或 PR）
5. 將決策、命令、差異與回復指令寫入 `CLAUDE_DECISIONS.md`

## 安全與限制
- 不主動攜帶任何 secrets；若必須，請先提示改用短期 token 或本機環境變數
- 預設唯讀；需要寫入時先彙整差異與風險，再徵詢一次性同意

## 範例用語
- 「這是一個大規模重構，建議交由 /interop-broker 做並行候選與收斂，是否同意一次性授權？」
- 「我已準備好唯讀上下文與命令草案，要直接交給 Codex/Gemini，還是先看草案？」
