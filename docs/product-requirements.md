# プロダクト要求定義書

## 1. プロダクトビジョンと目的

### ビジョン
開発者の「次に何をすべきか」を自動で導き出す、CLIファーストのタスク管理ツール。

### 目的
- 開発ワークフロー（Git操作、コーディング）の中にタスク管理を自然に統合する
- ルールベースの優先順位自動調整により、手動でのタスク整理コストを削減する
- ローカルファースト・Markdownベースで、開発者が慣れた環境で動作する

### プロダクト名
**DevTask**（仮称）

### スコープ外（MVPに含めないもの）
以下の機能はMVPの対象外とし、将来的な拡張として検討する。

- **チーム機能** - 複数ユーザーでのタスク共有、アサイン、コメント、メンション
- **プロジェクト管理** - ガントチャート、バーンダウンチャート、スプリント管理
- **Web UI / モバイルアプリ** - MVP はCLIのみ
- **外部サービス連携** - Sentry, Slack, GitHub Issues等との自動連携
- **AI による優先度判定** - MVP はシンプルなルールベースに限定
- **リアルタイム同期** - 複数デバイス間のデータ同期

## 2. ターゲットユーザー

### プライマリ（MVP）
- **個人開発者**
  - 日常的にターミナルとGitを使っている
  - CLIツールのインストール（npm install -g）に抵抗がない
  - 既存のタスク管理ツール（Todoist, Trello等）に「開発との距離」を感じている
  - タスクの優先順位付けに時間を取られたくない

### ペルソナ

#### ペルソナA: 個人開発者 / サイドプロジェクト型
- **属性**: フルスタックエンジニア、本業 + 個人プロジェクト2〜3本を並行
- **ワークフロー**: ターミナル常駐、VS Code + CLI中心、1日10回以上ターミナルを使う
- **現在のツール**: GitHub Issues + メモ帳、またはTodoist（ただしブラウザ切り替えが面倒で形骸化）
- **ペイン**: 「今日どのプロジェクトのどのタスクからやるべきか」の判断に毎朝15分使っている
- **期待**: ターミナルを開いたら「次はこれ」と言ってほしい

#### ペルソナB: 学習・成長志向型
- **属性**: ジュニア〜ミドルのエンジニア、技術学習とタスク管理を両立したい
- **ワークフロー**: VS Code中心、Git操作は基本的なものを使う
- **現在のツール**: Trello（カードが溜まって放置気味）
- **ペイン**: やるべきことは分かっているが、優先順位を付けられず全部中途半端になる
- **期待**: 締め切りや依存関係から「これを先にやるべき」と教えてほしい

### Post-MVP ターゲット
- 小規模チーム（2〜5名）の開発者

## 3. 課題とニーズ

| 課題 | ニーズ |
|------|--------|
| タスクの優先度を手動で管理するのが面倒 | 状況に応じて自動的に優先度が調整されてほしい |
| GUIツールとターミナルの切り替えが煩わしい | CLIで完結したい |
| タスクとコード（ブランチ）の関連が頭の中だけにある | タスクとGitブランチを紐付けたい |
| 「次に何をやるべきか」の判断に時間がかかる | 最適なタスクを提案してほしい |
| タスクデータがSaaSに閉じ込められる | ローカルにデータを持ちたい |

## 4. 主要な機能一覧（MVP）

### 4.1 タスクCRUD
- タスクの作成・一覧表示・更新・削除
- Markdownファイルとしてローカル保存（`.devtask/` ディレクトリ）
- タグ、手動優先度、見積もり時間の設定

### 4.2 タスク依存関係
- タスク間のブロック関係を定義（`blocks` / `blocked_by`）
- 依存関係を考慮したタスク一覧表示
- 循環依存の検出と警告

### 4.3 Git連携
- タスクとGitブランチの紐付け
- ブランチの停滞検出（最終コミットからの経過時間）
- 現在のブランチに関連するタスクの自動ハイライト

### 4.4 ルールベース優先順位自動調整
- 以下のルールに基づいてスコアを自動計算:
  - **ブロッカー影響度** - 他タスクを多くブロックしているほどスコア上昇
  - **締め切り近接度** - 期限が近いほどスコア上昇
  - **ブランチ停滞度** - 紐付きブランチが長期間未更新だとスコア上昇
  - **手動優先度** - ユーザーが明示的に設定した優先度を加算
- スコアは0〜100の範囲で正規化して表示
- 各ルールの重みはユーザーがカスタマイズ可能（デフォルト値は後述）
- `task why <id>` でスコア内訳を表示（透明性の確保）

#### デフォルトのスコア重み配分
| ルール | デフォルト重み | 説明 |
|--------|-------------|------|
| ブロッカー影響度 | 35 | ブロックしているタスク数に応じて加算 |
| 締め切り近接度 | 30 | 残り日数が少ないほど高スコア |
| 手動優先度 | 25 | low=0, medium=8, high=17, critical=25 |
| ブランチ停滞度 | 10 | 3日以上未更新で加算開始、7日以上で最大 |

### 4.5 タスク提案
- `task next` で最もスコアの高い未完了タスクを提案
- ブロックされているタスクは除外
- 提案理由を表示

## 5. 成功の定義

### MVP完了の判定基準
MVP完成とリリース可否を判断するための具体的基準:

- [ ] 全ユーザーストーリー（US-01〜US-13）の受け入れ条件をパスしている
- [ ] 自分自身が1週間日常的に使えている（ドッグフーディング）
- [ ] CLIの全コマンドがタスク100件で200ms以内に応答する
- [ ] `task next` の提案が直感的に妥当と感じる（7割以上の場面で提案に従う）
- [ ] README.md にインストール方法・基本的な使い方が記載されている

### プロダクト成功指標（公開後に測定）
| 指標 | 目標値 | 測定方法 |
|------|--------|---------|
| GitHub Stars | 公開3ヶ月で100+ | GitHub |
| npm週間ダウンロード数 | 公開3ヶ月で200+/週 | npm stats |
| Issue / PR による外部コントリビューション | 公開6ヶ月で5件+ | GitHub |

### 品質指標
| 指標 | 基準 |
|------|------|
| CLI応答速度 | 全コマンド200ms以内（タスク1,000件） |
| 起動時間 | 100ms以内 |
| タスクデータの可読性 | Markdownファイルを直接読んで内容を理解できる |
| テストカバレッジ | コアロジック（スコア計算、依存関係解析）は90%以上 |

## 6. ユーザーストーリー

### タスク管理
- **US-01**: 開発者として、CLIからタスクを作成したい。素早く記録できるように。
- **US-02**: 開発者として、タスク一覧を優先度スコア順に表示したい。重要なものから把握できるように。
- **US-03**: 開発者として、タスクにタグを付けたい。分類・フィルタリングできるように。
- **US-04**: 開発者として、タスクのステータスを変更したい。進捗を管理できるように。
- **US-05**: 開発者として、タスクを削除したい。不要になったタスクを整理できるように。

### 依存関係
- **US-06**: 開発者として、タスク間の依存関係を設定したい。作業順序を明確にできるように。
- **US-07**: 開発者として、ブロック中のタスクが一目でわかるようにしたい。着手可能なタスクだけに集中できるように。

### Git連携
- **US-08**: 開発者として、タスクにGitブランチを紐付けたい。コードとタスクの関連を追跡できるように。
- **US-09**: 開発者として、長期間更新のないブランチのタスクを警告してほしい。放置タスクに気付けるように。
- **US-10**: 開発者として、現在のブランチに関連するタスクを自動表示したい。コンテキストに合った情報を得るために。

### 優先順位
- **US-11**: 開発者として、`task next` で次にやるべきタスクを提案してほしい。判断コストを下げるために。
- **US-12**: 開発者として、優先度スコアの理由を確認したい。提案に納得して作業を始められるように。
- **US-13**: 開発者として、スコア計算の重みをカスタマイズしたい。自分のワークフローに合わせるために。

## 7. 受け入れ条件

### タスクCRUD（US-01〜US-05）
- `task add "<タイトル>"` でタスクが作成され、`.devtask/tasks/` にMarkdownファイルが生成される
- タスクIDはプロジェクト内で連番（1, 2, 3...）で自動採番される
- `task list` で全タスクが優先度スコア降順で表示される
- `task list --tag <tag>` でタグフィルタリングができる
- `task list --status <status>` でステータスフィルタリングができる
- `task update <id> --status done` でステータス変更ができる
- `task delete <id>` で確認プロンプトが表示され、承認後にタスクファイルが物理削除される
- `task delete <id> --force` で確認なしに削除される
- 依存関係を持つタスクを削除しようとした場合、影響を受けるタスクが警告表示され、確認後に依存関係も自動解除される

### 依存関係（US-06〜US-07）
- `task add "<タイトル>" --blocks <id>` で依存関係が設定できる
- `task update <id> --blocks <id>` で既存タスクに依存関係を追加できる
- `task list` でブロックされたタスクに `[blocked]` マークが表示される
- 循環依存を設定しようとするとエラーが表示され、設定が拒否される

### Git連携（US-08〜US-10）
- `task add "<タイトル>" --branch <branch-name>` でブランチ紐付けができる
- `task update <id> --branch <branch-name>` で既存タスクにブランチを紐付けられる
- 3日以上コミットのないブランチに紐付くタスクに `[stale]` マークが表示される
- 紐付けられたブランチがローカルに存在しない場合、`[branch not found]` マークが表示される
- `task list` 実行時、現在のGitブランチに紐付くタスクが上位に表示される
- Gitリポジトリ外で実行した場合、Git連携機能は無効化されエラーにはならない

### 優先順位（US-11〜US-13）
- `task next` で最高スコアの未ブロック・未完了タスクが提案理由とともに表示される
- 全タスクが完了済みの場合、「全タスク完了」メッセージが表示される
- 未完了タスクが全てブロック状態の場合、ブロック解除が必要なタスクの一覧が表示される
- `task why <id>` でスコア内訳（各ルールの寄与度）が表示される
- `task config weights.<rule> <value>` でスコアの重みを変更できる

## 8. 機能要件

### データ保存
- タスクデータは `.devtask/tasks/` 配下に1タスク1ファイルのMarkdownファイルとして保存
- ファイル名: `<id>.md`（例: `1.md`, `2.md`）
- ファイル形式: YAML Front Matter + Markdown本文
- 採番管理: `.devtask/meta.yml` に `next_id` を保持
- 設定ファイル: `.devtask/config.yml`
- すべてのデータはGitで管理可能

#### タスクファイルの形式例

```markdown
---
id: 1
title: 認証ミドルウェアの実装
status: in_progress
priority: high
tags: [backend, auth]
estimate: 4h
due: 2025-02-15
branch: feature/auth-middleware
blocks: [2, 3]
blocked_by: []
created_at: 2025-02-01T10:00:00+09:00
updated_at: 2025-02-03T14:30:00+09:00
---

## 説明

JWT認証のミドルウェアを実装する。
Express.jsのミドルウェアとして動作し、Authorization ヘッダーを検証する。
```

### タスクのデータ構造
| フィールド | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| id | number | 自動 | プロジェクト内連番 |
| title | string | 必須 | タスクタイトル |
| status | enum | 必須 | `todo` \| `in_progress` \| `done` |
| priority | enum | 任意 | `low` \| `medium`(デフォルト) \| `high` \| `critical` |
| tags | string[] | 任意 | タグの配列 |
| estimate | string | 任意 | 見積もり時間（例: `4h`, `30m`） |
| due | date | 任意 | 締め切り（YYYY-MM-DD） |
| branch | string | 任意 | 紐付きGitブランチ名 |
| blocks | number[] | 任意 | このタスクがブロックするタスクのID配列 |
| blocked_by | number[] | 任意 | このタスクをブロックしているタスクのID配列 |
| created_at | datetime | 自動 | 作成日時（ISO 8601） |
| updated_at | datetime | 自動 | 更新日時（ISO 8601） |

### CLIコマンド体系
| コマンド | 説明 |
|---------|------|
| `task init` | カレントディレクトリに `.devtask/` を初期化 |
| `task add "<title>" [options]` | タスク作成 |
| `task list [options]` | タスク一覧（スコア順） |
| `task show <id>` | タスク詳細表示 |
| `task update <id> [options]` | タスク更新 |
| `task delete <id> [--force]` | タスク削除 |
| `task next` | 次のタスク提案 |
| `task why <id>` | スコア内訳表示 |
| `task config <key> [value]` | 設定の表示・変更 |

## 9. 非機能要件

### パフォーマンス
- 全CLIコマンドのレスポンス: 200ms以内（タスク数1,000件まで）
- 起動時間: 100ms以内

### 対応プラットフォーム
- **MVP対応**: macOS, Linux
- **MVP対象外**: Windows（Post-MVPで対応検討）
- Node.js 18以上で動作

### 配布方法
- **プライマリ**: npm（`npm install -g devtask`）
- **Post-MVP**: Homebrew対応を検討

### データ
- オフライン完全動作
- データのエクスポート不要（ファイルがそのままデータ）

### ユーザビリティ
- カラー出力対応（`--no-color` フラグでプレーンテキスト出力に切替可能）
- `--help` による各コマンドのヘルプ表示
- エラーメッセージは具体的で、対処方法を含む

### テスト容易性
- コアロジック（スコア計算、依存関係解析）はユニットテスト必須（カバレッジ90%以上）
- CLIコマンドのE2Eテスト: 主要なユースケースをカバー

### 後方互換性
- タスクファイルのYAML Front MatterにSchemaバージョンを含めない（MVP段階では不要）
- 破壊的変更が必要になった場合はマイグレーションコマンド（`task migrate`）で対応する方針

### ロケール
- CLI出力は**英語のみ**（MVP）
- タスクのタイトル・説明はユーザーが任意の言語で記述可能
