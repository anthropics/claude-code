<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ—„ï¸ ENSIDE DATABASE v6.15 - ULTRA COMPLETO</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --primary: #1a5f2a; --secondary: #2e8b3e; --success: #28a745; --danger: #dc3545; --warning: #ffc107; --whatsapp: #25D366; --dark: #2c3e50; --info: #17a2b8; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); min-height: 100vh; padding: 10px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .panel { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); margin-bottom: 12px; }
        .header { text-align: center; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0; }
        .header h1 { color: var(--primary); font-size: 1.6em; }
        .header .badge-version { background: linear-gradient(135deg, #4ade80, #22c55e); color: #000; padding: 6px 15px; border-radius: 20px; font-weight: bold; display: inline-block; margin: 10px 5px 0; }
        .header .badge-wa { background: linear-gradient(135deg, var(--whatsapp), #128C7E); color: white; padding: 6px 15px; border-radius: 20px; font-weight: bold; display: inline-block; margin: 10px 5px 0; }
        .tabs { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 12px; }
        .tab-btn { padding: 8px 12px; background: #f5f5f5; border: none; cursor: pointer; font-weight: 600; color: #666; border-radius: 8px; transition: all 0.3s; font-size: 0.85em; display: flex; align-items: center; gap: 4px; }
        .tab-btn:hover { background: #e8e8e8; }
        .tab-btn.active { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; }
        .tab-btn .badge { background: rgba(255,255,255,0.3); padding: 2px 6px; border-radius: 10px; font-size: 0.75em; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .section-title { color: var(--primary); font-size: 1.2em; margin-bottom: 15px; font-weight: 600; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }
        .alert { padding: 12px 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid; font-size: 0.9em; }
        .alert.success { background: #d4edda; border-left-color: var(--success); color: #155724; }
        .alert.error { background: #f8d7da; border-left-color: var(--danger); color: #721c24; }
        .alert.info { background: #d1ecf1; border-left-color: var(--info); color: #0c5460; }
        .alert.warning { background: #fff3cd; border-left-color: var(--warning); color: #856404; }
        .alert.whatsapp { background: #d4edda; border-left-color: var(--whatsapp); color: #155724; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px; margin: 15px 0; }
        .stat { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 12px; border-radius: 12px; text-align: center; }
        .stat.success { background: linear-gradient(135deg, var(--success), #20c997); }
        .stat.warning { background: linear-gradient(135deg, var(--warning), #fd7e14); color: #333; }
        .stat.whatsapp { background: linear-gradient(135deg, var(--whatsapp), #128C7E); }
        .stat.info { background: linear-gradient(135deg, var(--info), #0dcaf0); }
        .stat-number { font-size: 1.6em; font-weight: bold; }
        .stat-label { font-size: 0.75em; opacity: 0.9; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; margin-bottom: 4px; font-weight: 600; color: #333; font-size: 0.85em; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95em; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; }
        button { padding: 10px 16px; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin: 4px; transition: all 0.3s; font-size: 0.9em; }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .btn-full { width: 100%; margin: 6px 0; padding: 12px; }
        .btn-success { background: linear-gradient(135deg, var(--success), #20c997); }
        .btn-danger { background: linear-gradient(135deg, var(--danger), #e74c3c); }
        .btn-whatsapp { background: linear-gradient(135deg, var(--whatsapp), #128C7E); }
        .btn-warning { background: linear-gradient(135deg, var(--warning), #fd7e14); color: #333; }
        .btn-info { background: linear-gradient(135deg, var(--info), #0dcaf0); }
        .btn-small { padding: 6px 10px; font-size: 0.8em; margin: 2px; }
        .search-box input { width: 100%; padding: 10px 10px 10px 35px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95em; background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23999' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E") no-repeat 10px center; background-size: 16px; margin-bottom: 10px; }
        .card { background: #f9f9f9; padding: 12px; border-radius: 10px; margin-bottom: 8px; border-left: 4px solid var(--primary); }
        .card:hover { transform: translateX(3px); box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; flex-wrap: wrap; gap: 4px; }
        .card-badge { padding: 2px 8px; border-radius: 10px; font-size: 0.7em; font-weight: 600; }
        .badge-motorista { background: #e8f5e9; color: #388e3c; }
        .badge-fornecedor { background: #fff3e0; color: #f57c00; }
        .badge-cliente { background: #e3f2fd; color: #1976d2; }
        .card-field { color: #666; font-size: 0.85em; margin: 3px 0; }
        .card-field a { color: var(--whatsapp); text-decoration: none; font-weight: 600; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85em; }
        thead { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; }
        th, td { padding: 8px; text-align: left; }
        tbody tr { border-bottom: 1px solid #eee; }
        tbody tr:hover { background: #f9f9f9; }
        .chat-box { border: 2px solid var(--whatsapp); border-radius: 12px; overflow: hidden; margin-top: 15px; }
        .chat-header { background: linear-gradient(135deg, var(--whatsapp), #128C7E); color: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; }
        .chat-messages { height: 300px; overflow-y: auto; padding: 12px; background: #e5ddd5; }
        .chat-msg { margin: 8px 0; padding: 10px 12px; border-radius: 10px; max-width: 85%; line-height: 1.4; font-size: 0.9em; }
        .chat-msg.user { background: #dcf8c6; margin-left: auto; border-bottom-right-radius: 4px; }
        .chat-msg.agent { background: white; border: 1px solid #e0e0e0; border-bottom-left-radius: 4px; }
        .chat-msg .time { font-size: 0.7em; opacity: 0.6; margin-top: 4px; text-align: right; }
        .chat-input { display: flex; border-top: 2px solid var(--whatsapp); }
        .chat-input input { flex: 1; padding: 12px; border: none; font-size: 0.95em; }
        .chat-input button { border-radius: 0; margin: 0; }
        .knowledge-card { background: linear-gradient(135deg, #f0fdf4, #dcfce7); padding: 12px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid var(--success); }
        .knowledge-card h4 { color: var(--primary); margin-bottom: 6px; font-size: 1em; }
        .knowledge-card p { color: #333; line-height: 1.4; font-size: 0.9em; }
        .knowledge-tags { display: flex; gap: 4px; margin-top: 8px; flex-wrap: wrap; }
        .knowledge-tag { background: var(--primary); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7em; }
        .inner-tabs { display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap; }
        .inner-tab { padding: 6px 12px; background: #f0f0f0; border: none; cursor: pointer; color: #666; font-weight: 600; border-radius: 6px; font-size: 0.85em; }
        .inner-tab.active { background: var(--primary); color: white; }
        .inner-content { display: none; }
        .inner-content.active { display: block; }
        .upload-area { border: 3px dashed var(--primary); border-radius: 12px; padding: 25px; text-align: center; cursor: pointer; background: #f9f9f9; transition: all 0.3s; }
        .upload-area:hover { background: #f0f0ff; }
        .upload-area.dragover { background: #e0ffe0; border-color: var(--success); }
        .progress-bar { height: 10px; background: #e0e0e0; border-radius: 5px; overflow: hidden; margin: 8px 0; }
        .progress-fill { height: 100%; background: linear-gradient(135deg, var(--primary), var(--secondary)); transition: width 0.5s; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9f9f9; border-radius: 10px; margin-bottom: 8px; border-left: 4px solid var(--primary); }
        .list-count { background: var(--primary); color: white; padding: 4px 12px; border-radius: 15px; font-weight: 600; font-size: 0.85em; }
        .triagem-preview { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin: 12px 0; }
        .triagem-item { padding: 12px; border-radius: 10px; text-align: center; }
        .triagem-item.motorista { background: #e8f5e9; border: 2px solid #388e3c; }
        .triagem-item.fornecedor { background: #fff3e0; border: 2px solid #f57c00; }
        .triagem-item.cliente { background: #e3f2fd; border: 2px solid #1976d2; }
        .triagem-item .numero { font-size: 1.8em; font-weight: bold; }
        input[type="file"] { display: none; }
        @media (max-width: 600px) {
            .form-row { grid-template-columns: 1fr; }
            .dashboard { grid-template-columns: repeat(2, 1fr); }
            .tabs { justify-content: center; }
            .triagem-preview { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="panel">
        <div class="header">
            <h1>ğŸ—„ï¸ ENSIDE DATABASE v6.15</h1>
            <p><strong>Enside Madeiras</strong> - Anderson Enside | Sistema ULTRA COMPLETO</p>
            <div>
                <span class="badge-version">v6.15 ULTRA</span>
                <span class="badge-wa">ğŸ“± 5518996540492</span>
            </div>
        </div>
    </div>

    <div class="panel">
        <div class="tabs">
            <button class="tab-btn active" onclick="abrirAba('inicio',this)">ğŸ  InÃ­cio</button>
            <button class="tab-btn" onclick="abrirAba('motoristas',this)">ğŸšš <span class="badge" id="badgeMot">0</span></button>
            <button class="tab-btn" onclick="abrirAba('fornecedores',this)">ğŸ“¦ <span class="badge" id="badgeFor">0</span></button>
            <button class="tab-btn" onclick="abrirAba('clientes',this)">ğŸ‘¥ <span class="badge" id="badgeCli">0</span></button>
            <button class="tab-btn" onclick="abrirAba('cadastrar',this)">â• Cadastrar</button>
            <button class="tab-btn" onclick="abrirAba('importar',this)">ğŸ“¤ Importar</button>
            <button class="tab-btn" onclick="abrirAba('listas',this)">ğŸ“‹ Listas</button>
            <button class="tab-btn" onclick="abrirAba('agente',this)">ğŸ§  Agente IA</button>
            <button class="tab-btn" onclick="abrirAba('whatsapp',this)">ğŸ“± WhatsApp</button>
            <button class="tab-btn" onclick="abrirAba('conhecimentos',this)">ğŸ“š Conhec. <span class="badge" id="badgeConh">0</span></button>
            <button class="tab-btn" onclick="abrirAba('google',this)">ğŸ“Š Google</button>
            <button class="tab-btn" onclick="abrirAba('exportar',this)">ğŸ’¾ Exportar</button>
        </div>
    </div>

    <!-- INÃCIO -->
    <div id="inicio" class="tab-content active">
        <div class="panel">
            <div class="section-title">ğŸ  Dashboard Principal</div>
            <div id="alertaMigracao"></div>
            <div class="dashboard">
                <div class="stat"><div class="stat-number" id="sTotal">0</div><div class="stat-label">Total</div></div>
                <div class="stat success"><div class="stat-number" id="sMot">0</div><div class="stat-label">Motoristas</div></div>
                <div class="stat warning"><div class="stat-number" id="sFor">0</div><div class="stat-label">Fornecedores</div></div>
                <div class="stat info"><div class="stat-number" id="sCli">0</div><div class="stat-label">Clientes</div></div>
                <div class="stat whatsapp"><div class="stat-number" id="sWa">0</div><div class="stat-label">WhatsApp</div></div>
                <div class="stat"><div class="stat-number" id="sConh">0</div><div class="stat-label">Conhecimentos</div></div>
            </div>
            <div style="margin:15px 0;padding:15px;background:linear-gradient(135deg,#f0fdf4,#dcfce7);border-radius:12px;border:2px solid var(--success);">
                <h4 style="color:var(--primary);margin-bottom:12px;">ğŸ§  Status do Agente IA</h4>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;font-size:0.9em;">
                    <div><strong>NÃ­vel:</strong> <span id="dashNivel">1</span></div>
                    <div><strong>XP:</strong> <span id="dashXP">0</span></div>
                    <div><strong>PrecisÃ£o:</strong> <span id="dashPrecisao">50%</span></div>
                    <div><strong>Conversas:</strong> <span id="dashConv">0</span></div>
                </div>
                <div style="margin-top:12px;">
                    <p style="font-weight:600;color:#333;font-size:0.9em;">Aprendizado:</p>
                    <div class="progress-bar"><div class="progress-fill" id="dashProgress" style="width:10%"></div></div>
                    <p style="color:#666;font-size:0.8em;" id="dashProgressText">10% - Iniciante</p>
                </div>
            </div>
            <table>
                <thead><tr><th>Categoria</th><th>Total</th><th>WhatsApp</th><th>Completos</th></tr></thead>
                <tbody id="tblAnalise"></tbody>
            </table>
        </div>
    </div>

    <!-- MOTORISTAS -->
    <div id="motoristas" class="tab-content">
        <div class="panel">
            <div class="section-title">ğŸšš Motoristas / Fretes</div>
            <div class="form-row" style="margin-bottom:10px;">
                <div class="search-box" style="flex:2;margin:0;"><input type="text" id="buscaMot" placeholder="Buscar motorista..." oninput="filtrarMotoristas()"></div>
                <select id="filtroTipoMot" onchange="filtrarMotoristas()" style="padding:8px;border:2px solid #e0e0e0;border-radius:8px;font-size:0.9em;">
                    <option value="">Todos tipos</option>
                    <option value="truck">Truck</option>
                    <option value="carreta">Carreta</option>
                    <option value="bi-trem">Bi-trem</option>
                    <option value="rodotrem">Rodotrem</option>
                </select>
                <select id="filtroUFMot" onchange="filtrarMotoristas()" style="padding:8px;border:2px solid #e0e0e0;border-radius:8px;font-size:0.9em;"></select>
            </div>
            <div id="listaMot"></div>
        </div>
    </div>

    <!-- FORNECEDORES -->
    <div id="fornecedores" class="tab-content">
        <div class="panel">
            <div class="section-title">ğŸ“¦ Fornecedores</div>
            <div class="form-row" style="margin-bottom:10px;">
                <div class="search-box" style="flex:2;margin:0;"><input type="text" id="buscaFor" placeholder="Buscar fornecedor..." oninput="filtrarFornecedores()"></div>
                <select id="filtroUFFor" onchange="filtrarFornecedores()" style="padding:8px;border:2px solid #e0e0e0;border-radius:8px;font-size:0.9em;"></select>
            </div>
            <div id="listaFor"></div>
        </div>
    </div>

    <!-- CLIENTES -->
    <div id="clientes" class="tab-content">
        <div class="panel">
            <div class="section-title">ğŸ‘¥ Clientes</div>
            <div class="form-row" style="margin-bottom:10px;">
                <div class="search-box" style="flex:2;margin:0;"><input type="text" id="buscaCli" placeholder="Buscar cliente..." oninput="filtrarClientes()"></div>
                <select id="filtroUFCli" onchange="filtrarClientes()" style="padding:8px;border:2px solid #e0e0e0;border-radius:8px;font-size:0.9em;"></select>
            </div>
            <div id="listaCli"></div>
        </div>
    </div>

    <!-- CADASTRAR -->
    <div id="cadastrar" class="tab-content">
        <div class="panel">
            <div class="section-title">â• Novo Cadastro (50+ Campos)</div>
            <div class="inner-tabs">
                <button class="inner-tab active" onclick="abrirInner('cadBasico',this)">ğŸ“ BÃ¡sico</button>
                <button class="inner-tab" onclick="abrirInner('cadFrete',this)">ğŸšš Frete</button>
                <button class="inner-tab" onclick="abrirInner('cadVeiculo',this)">ğŸš› VeÃ­culo</button>
                <button class="inner-tab" onclick="abrirInner('cadPagamento',this)">ğŸ’° Pagamento</button>
            </div>

            <div id="cadBasico" class="inner-content active">
                <div class="form-row">
                    <div class="form-group"><label>Categoria *</label>
                        <select id="cadCategoria">
                            <option value="motoristas">ğŸšš Motorista/Frete</option>
                            <option value="fornecedores">ğŸ“¦ Fornecedor</option>
                            <option value="clientes">ğŸ‘¥ Cliente</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Nome/RazÃ£o Social *</label><input type="text" id="cadNome" placeholder="Nome completo"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Telefone</label><input type="text" id="cadTelefone" placeholder="(00) 0000-0000"></div>
                    <div class="form-group"><label>WhatsApp</label><input type="text" id="cadWhatsapp" placeholder="(00) 00000-0000"></div>
                    <div class="form-group"><label>Email</label><input type="email" id="cadEmail" placeholder="email@exemplo.com"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Cidade</label><input type="text" id="cadCidade"></div>
                    <div class="form-group"><label>UF</label><input type="text" id="cadUF" maxlength="2" placeholder="SP"></div>
                    <div class="form-group"><label>CEP</label><input type="text" id="cadCEP" placeholder="00000-000"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>CNPJ/CPF</label><input type="text" id="cadDocumento"></div>
                    <div class="form-group"><label>Contato</label><input type="text" id="cadContato" placeholder="Nome do contato"></div>
                </div>
            </div>

            <div id="cadFrete" class="inner-content">
                <div class="form-row">
                    <div class="form-group"><label>Tipo de Carga</label>
                        <select id="cadTipoCarga">
                            <option value="">Selecione...</option>
                            <option value="madeira_serrada">Madeira Serrada</option>
                            <option value="madeira_tora">Madeira em Tora</option>
                            <option value="compensado">Compensado/MDF</option>
                            <option value="pinus">Pinus</option>
                            <option value="eucalipto">Eucalipto</option>
                            <option value="mista">Carga Mista</option>
                        </select>
                    </div>
                    <div class="form-group"><label>RegiÃ£o de AtuaÃ§Ã£o</label><input type="text" id="cadRegiao" placeholder="Ex: SP, PR, SC"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Origem Preferencial</label><input type="text" id="cadOrigem" placeholder="Cidade/UF"></div>
                    <div class="form-group"><label>Destino Preferencial</label><input type="text" id="cadDestino" placeholder="Cidade/UF"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Capacidade (ton)</label><input type="number" id="cadCapacidade" placeholder="Ex: 30"></div>
                    <div class="form-group"><label>Valor MÃ©dio Frete (R$/ton)</label><input type="number" id="cadValorFrete" placeholder="Ex: 150"></div>
                </div>
                <div class="form-group"><label>Rotas Frequentes</label><textarea id="cadRotas" rows="2" placeholder="Ex: SP-PR, SC-RS..."></textarea></div>
            </div>

            <div id="cadVeiculo" class="inner-content">
                <div class="form-row">
                    <div class="form-group"><label>Tipo de VeÃ­culo</label>
                        <select id="cadTipoVeiculo">
                            <option value="">Selecione...</option>
                            <option value="truck">Truck</option>
                            <option value="carreta">Carreta</option>
                            <option value="bi-trem">Bi-trem</option>
                            <option value="rodotrem">Rodotrem</option>
                            <option value="van">Van/FurgÃ£o</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Placa</label><input type="text" id="cadPlaca" placeholder="ABC-1234"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Marca</label><input type="text" id="cadMarca" placeholder="Ex: Scania"></div>
                    <div class="form-group"><label>Modelo</label><input type="text" id="cadModelo" placeholder="Ex: R450"></div>
                    <div class="form-group"><label>Ano</label><input type="number" id="cadAno" placeholder="2023"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>RNTRC</label><input type="text" id="cadRNTRC"></div>
                    <div class="form-group"><label>CNH Categoria</label><input type="text" id="cadCNH" placeholder="E"></div>
                </div>
            </div>

            <div id="cadPagamento" class="inner-content">
                <div class="form-row">
                    <div class="form-group"><label>Forma de Pagamento</label>
                        <select id="cadFormaPagamento">
                            <option value="">Selecione...</option>
                            <option value="pix">PIX</option>
                            <option value="transferencia">TransferÃªncia</option>
                            <option value="boleto">Boleto</option>
                            <option value="cheque">Cheque</option>
                            <option value="dinheiro">Dinheiro</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Prazo Pagamento</label>
                        <select id="cadPrazoPagamento">
                            <option value="">Selecione...</option>
                            <option value="avista">Ã€ Vista</option>
                            <option value="7dias">7 dias</option>
                            <option value="15dias">15 dias</option>
                            <option value="30dias">30 dias</option>
                            <option value="negociar">A negociar</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Banco</label><input type="text" id="cadBanco"></div>
                    <div class="form-group"><label>AgÃªncia</label><input type="text" id="cadAgencia"></div>
                    <div class="form-group"><label>Conta</label><input type="text" id="cadConta"></div>
                </div>
                <div class="form-group"><label>Chave PIX</label><input type="text" id="cadPix"></div>
            </div>

            <div class="form-group"><label>ObservaÃ§Ãµes</label><textarea id="cadObs" rows="2" placeholder="ObservaÃ§Ãµes gerais..."></textarea></div>
            <button onclick="salvarCadastro()" class="btn-success btn-full">ğŸ’¾ Salvar Cadastro</button>
            <div id="alertaCad"></div>
        </div>
    </div>

    <!-- IMPORTAR -->
    <div id="importar" class="tab-content">
        <div class="panel">
            <div class="section-title">ğŸ“¤ Importador Inteligente</div>
            <div class="alert info">ğŸ¯ <strong>Triagem AutomÃ¡tica:</strong> 1Âº Motoristas/Fretes â†’ 2Âº Fornecedores â†’ 3Âº Clientes</div>
            <div class="upload-area" id="dropZone" onclick="document.getElementById('fileInput').click()">
                <div style="font-size:2em;margin-bottom:8px">ğŸ“</div>
                <div style="color:var(--primary);font-weight:600;">Clique ou arraste arquivos</div>
                <div style="color:#999;margin-top:8px;font-size:0.9em;">CSV, Excel (.xlsx), JSON</div>
            </div>
            <input type="file" id="fileInput" accept=".csv,.xlsx,.json,.txt" onchange="importarArquivo(event)">
            <div id="alertaImport"></div>
            <div id="triagemPreview" style="display:none;margin-top:15px;">
                <h4 style="color:var(--primary);margin-bottom:10px;">ğŸ§  PrÃ©via da Triagem:</h4>
                <div class="triagem-preview">
                    <div class="triagem-item motorista"><div class="numero" id="prevMot">0</div><div>ğŸšš Motoristas</div></div>
                    <div class="triagem-item fornecedor"><div class="numero" id="prevFor">0</div><div>ğŸ“¦ Fornecedores</div></div>
                    <div class="triagem-item cliente"><div class="numero" id="prevCli">0</div><div>ğŸ‘¥ Clientes</div></div>
                </div>
                <button onclick="confirmarImportacao()" class="btn-success btn-full">âœ… Confirmar</button>
                <button onclick="cancelarImportacao()" class="btn-danger btn-full">âŒ Cancelar</button>
            </div>
        </div>
    </div>

    <!-- LISTAS -->
    <div id="listas" class="tab-content">
        <div class="panel">
            <div class="section-title">ğŸ“‹ Listas de TransmissÃ£o</div>
            <div class="alert info">ğŸ“± <strong>Limite WhatsApp:</strong> 256 contatos por lista</div>
            <div class="inner-tabs">
                <button class="inner-tab active" onclick="abrirInner('listaCriar',this)">â• Criar</button>
                <button class="inner-tab" onclick="abrirInner('listaMinhas',this)">ğŸ“‹ Minhas Listas</button>
            </div>
            <div id="listaCriar" class="inner-content active">
                <div class="form-group"><label>Nome da Lista *</label><input type="text" id="listaNome" placeholder="Ex: Motoristas SP"></div>
                <div class="form-row">
                    <div class="form-group"><label>Tipo</label>
                        <select id="listaFiltroTipo" onchange="previewLista()">
                            <option value="">Todos</option>
                            <option value="motoristas">ğŸšš Motoristas</option>
                            <option value="fornecedores">ğŸ“¦ Fornecedores</option>
                            <option value="clientes">ğŸ‘¥ Clientes</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Estado</label><select id="listaFiltroUF" onchange="previewLista()"></select></div>
                </div>
                <div id="previewListaInfo" class="alert info" style="display:none;"></div>
                <button onclick="criarLista()" class="btn-success btn-full">âœ… Criar Lista</button>
                <div id="alertaLista"></div>
            </div>
            <div id="listaMinhas" class="inner-content"><div id="minhasListas"></div></div>
        </div>
    </div>

    <!-- AGENTE IA -->
    <div id="agente" class="tab-content">
        <div class="panel">
            <div class="section-title">ğŸ§  Agente IA - Busca em Conhecimentos</div>
            <div class="dashboard">
                <div class="stat"><div class="stat-number" id="agNivel">1</div><div class="stat-label">NÃ­vel</div></div>
                <div class="stat success"><div class="stat-number" id="agXP">0</div><div class="stat-label">XP</div></div>
                <div class="stat warning"><div class="stat-number" id="agPrecisao">50%</div><div class="stat-label">PrecisÃ£o</div></div>
                <div class="stat info"><div class="stat-number" id="agConh">0</div><div class="stat-label">Conhecimentos</div></div>
            </div>
            <div class="chat-box">
                <div class="chat-header">
                    <span>ğŸ¤– Enside Agent v6.15 | ğŸ“± 5518996540492</span>
                    <span id="agTyping" style="display:none;font-size:0.85em;">digitando...</span>
                </div>
                <div class="chat-messages" id="chatMsgs"></div>
                <div class="chat-input">
                    <input type="text" id="chatIn" placeholder="Pergunte algo... (busco nos conhecimentos)" onkeypress="if(event.key==='Enter')enviarMsg()">
                    <button onclick="enviarMsg()" class="btn-whatsapp">Enviar</button>
                </div>
            </div>
            <div class="alert info" style="margin-top:10px;font-size:0.85em;">
                ğŸ’¡ <strong>Comandos:</strong> "resumo", "quantos motoristas?", "buscar [termo]", "preÃ§o pinus", "frete sp pr"
            </div>
        </div>
    </div>

    <!-- WHATSAPP -->
    <div id="whatsapp" class="tab-content">
        <div class="panel">
            <div class="section-title">ğŸ“± WhatsApp - ConfiguraÃ§Ã£o e Monitoramento</div>
            <div style="background:linear-gradient(135deg,#d4edda,#c3e6cb);padding:15px;border-radius:12px;border:2px solid var(--whatsapp);margin-bottom:15px;">
                <h4 style="color:#155724;margin-bottom:10px;">ğŸ“± WhatsApp Vinculado</h4>
                <div class="form-row">
                    <div class="form-group"><label>NÃºmero *</label><input type="text" id="waNumero" value="5518996540492"></div>
                    <div class="form-group"><label>Nome</label><input type="text" id="waNome" value="Anderson Enside"></div>
                </div>
                <button onclick="salvarWhatsApp()" class="btn-whatsapp btn-full">ğŸ“± Salvar ConfiguraÃ§Ã£o</button>
            </div>
            <div style="margin-bottom:15px;">
                <h4 style="color:var(--primary);margin-bottom:10px;">ğŸ”— Webhook Evolution API</h4>
                <div class="form-group"><label>URL do Webhook</label><input type="text" id="waWebhook" placeholder="https://seu-servidor.com/webhook"></div>
                <div class="form-row">
                    <button onclick="salvarWebhook()" class="btn-success">ğŸ’¾ Salvar</button>
                    <button onclick="testarWebhook()" class="btn-warning">ğŸ§ª Testar</button>
                </div>
            </div>
            <div class="dashboard">
                <div class="stat whatsapp"><div class="stat-number" id="waConv">0</div><div class="stat-label">Conversas</div></div>
                <div class="stat success"><div class="stat-number" id="waMsgs">0</div><div class="stat-label">Mensagens</div></div>
                <div class="stat"><div class="stat-number" id="waAprend">0</div><div class="stat-label">Aprendizados</div></div>
            </div>
            <h4 style="margin:15px 0 10px;color:#333;">ğŸ“¬ Conversas Recentes</h4>
            <div id="waConversas"></div>
            <button onclick="simularConversa()" class="btn-whatsapp btn-full" style="margin-top:10px;">â• Simular Conversa (teste)</button>
        </div>
    </div>

    <!-- CONHECIMENTOS -->
    <div id="conhecimentos" class="tab-content">
        <div class="panel">
            <div class="section-title">ğŸ“š Base de Conhecimentos do Agente</div>
            <div class="alert success">ğŸ§  <strong>Importante!</strong> O Agente IA busca aqui PRIMEIRO para responder perguntas!</div>
            <div class="form-group"><label>TÃ­tulo *</label><input type="text" id="conhTitulo" placeholder="Ex: PreÃ§o frete SP-PR"></div>
            <div class="form-row">
                <div class="form-group"><label>Categoria</label>
                    <select id="conhCategoria">
                        <option value="fretes">ğŸšš Fretes/Rotas</option>
                        <option value="precos">ğŸ’° PreÃ§os</option>
                        <option value="produtos">ğŸªµ Produtos</option>
                        <option value="motoristas">ğŸš› Motoristas</option>
                        <option value="fornecedores">ğŸ“¦ Fornecedores</option>
                        <option value="clientes">ğŸ‘¥ Clientes</option>
                        <option value="processos">âš™ï¸ Processos</option>
                        <option value="outro">ğŸ“Œ Outro</option>
                    </select>
                </div>
            </div>
            <div class="form-group"><label>ConteÃºdo *</label><textarea id="conhConteudo" rows="3" placeholder="Ex: Frete SP-PR madeira custa R$ 180/ton..."></textarea></div>
            <div class="form-group"><label>Tags (separadas por vÃ­rgula)</label><input type="text" id="conhTags" placeholder="frete, sp, pr, preÃ§o, madeira"></div>
            <button onclick="salvarConhecimento()" class="btn-success btn-full">ğŸ’¾ Salvar Conhecimento</button>
            <div id="alertaConh"></div>
            <h4 style="margin:20px 0 10px;color:var(--primary);">ğŸ“– Conhecimentos Salvos (<span id="contConh">0</span>)</h4>
            <div class="search-box"><input type="text" id="buscaConh" placeholder="Buscar conhecimento..." oninput="filtrarConhecimentos()"></div>
            <div id="listaConh"></div>
        </div>
    </div>

    <!-- GOOGLE SHEETS -->
    <div id="google" class="tab-content">
        <div class="panel">
            <div class="section-title">ğŸ“Š Google Sheets - SincronizaÃ§Ã£o</div>
            <div class="alert info">ğŸ“‹ Planilha: <strong>Anderson Enside - Sistema Fretes</strong></div>
            <div style="background:#f5f5f5;padding:15px;border-radius:10px;margin-bottom:15px;">
                <p style="font-size:0.9em;word-break:break-all;"><strong>ID:</strong> 1NJRMB-pgEFS0MjtKrh2mhqPN6apkDwwJMAPOCejLX8Y</p>
                <p style="margin-top:8px;font-size:0.85em;"><a href="https://docs.google.com/spreadsheets/d/1NJRMB-pgEFS0MjtKrh2mhqPN6apkDwwJMAPOCejLX8Y/edit" target="_blank" style="color:var(--primary);">ğŸ”— Abrir no Google Sheets</a></p>
            </div>
            <h4 style="margin-bottom:10px;">ğŸ”„ Apps Script para SincronizaÃ§Ã£o</h4>
            <div class="alert warning" style="font-size:0.85em;">
                <strong>InstruÃ§Ãµes:</strong><br>
                1. Abra a planilha no Google Sheets<br>
                2. VÃ¡ em ExtensÃµes â†’ Apps Script<br>
                3. Cole o cÃ³digo abaixo e salve<br>
                4. Execute a funÃ§Ã£o <code>doGet</code> como Web App
            </div>
            <div style="background:#1e1e1e;color:#d4d4d4;padding:12px;border-radius:8px;font-family:monospace;font-size:0.8em;overflow-x:auto;margin:10px 0;">
<pre>function doGet(e) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var data = sheet.getDataRange().getValues();
  var headers = data[0];
  var result = [];

  for (var i = 1; i < data.length; i++) {
    var row = {};
    for (var j = 0; j < headers.length; j++) {
      row[headers[j]] = data[i][j];
    }
    result.push(row);
  }

  return ContentService.createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var data = JSON.parse(e.postData.contents);
  sheet.appendRow(Object.values(data));
  return ContentService.createTextOutput('OK');
}</pre>
            </div>
            <div class="form-group"><label>URL do Web App (apÃ³s publicar)</label><input type="text" id="googleWebApp" placeholder="https://script.google.com/macros/s/.../exec"></div>
            <div class="form-row">
                <button onclick="sincronizarGoogle()" class="btn-success btn-full">ğŸ”„ Sincronizar do Google</button>
                <button onclick="enviarParaGoogle()" class="btn-info btn-full">ğŸ“¤ Enviar para Google</button>
            </div>
            <div id="alertaGoogle"></div>
        </div>
    </div>

    <!-- EXPORTAR -->
    <div id="exportar" class="tab-content">
        <div class="panel">
            <div class="section-title">ğŸ’¾ Exportar Dados</div>
            <div class="form-row">
                <button onclick="exportCSV('motoristas')" class="btn-success btn-full">ğŸšš Motoristas CSV</button>
                <button onclick="exportCSV('fornecedores')" class="btn-success btn-full">ğŸ“¦ Fornecedores CSV</button>
                <button onclick="exportCSV('clientes')" class="btn-success btn-full">ğŸ‘¥ Clientes CSV</button>
            </div>
            <div class="form-row">
                <button onclick="exportCSV('conhecimentos')" class="btn-info btn-full">ğŸ“š Conhecimentos CSV</button>
                <button onclick="exportWhatsApp()" class="btn-whatsapp btn-full">ğŸ“± Lista WhatsApp</button>
            </div>
            <button onclick="exportJSON()" class="btn-full">ğŸ“‹ Backup Completo JSON</button>
            <hr style="margin:20px 0;border:1px solid #eee;">
            <button onclick="limparTudo()" class="btn-danger btn-full">ğŸ—‘ï¸ Limpar Todo o Banco</button>
        </div>
    </div>
</div>

<script>
// ============================================
// ENSIDE DATABASE v6.15 - ULTRA COMPLETO
// Anderson Enside | Enside Madeiras
// WhatsApp: 5518996540492
// Google Sheets: 1NJRMB-pgEFS0MjtKrh2mhqPN6apkDwwJMAPOCejLX8Y
// localStorage: enside_db_v5
// ============================================

let db = {
    motoristas: [],
    fornecedores: [],
    clientes: [],
    listas: [],
    conhecimentos: [],
    whatsapp: {
        numero: '5518996540492',
        nome: 'Anderson Enside',
        webhook: '',
        conversas: [],
        mensagens: 0,
        chatsAnalisados: 0
    },
    agente: {
        nivel: 1,
        xp: 0,
        precisao: 50,
        interacoes: 0,
        imports: 0,
        historico: []
    },
    config: {
        versao: '6.15.0',
        planilhaId: '1NJRMB-pgEFS0MjtKrh2mhqPN6apkDwwJMAPOCejLX8Y',
        googleWebApp: '',
        migrado: false,
        ultimaSync: null
    }
};

let dadosPendentes = null;

// CARREGAR DB COM MIGRAÃ‡ÃƒO AUTOMÃTICA
function carregarDB() {
    try {
        const saved = localStorage.getItem('enside_db_v5');
        if (saved) {
            const p = JSON.parse(saved);
            let migrou = false;

            // Migrar motoristas
            if (p.motoristas && p.motoristas.length > 0) {
                db.motoristas = p.motoristas;
                migrou = true;
            }

            // Migrar fornecedores
            if (p.fornecedores && p.fornecedores.length > 0) {
                db.fornecedores = p.fornecedores;
                migrou = true;
            }

            // Migrar clientes
            if (p.clientes && p.clientes.length > 0) {
                db.clientes = p.clientes;
                migrou = true;
            }

            // CRÃTICO: Migrar conhecimentos
            if (p.conhecimentos && p.conhecimentos.length > 0) {
                db.conhecimentos = p.conhecimentos;
                migrou = true;
                console.log('ğŸ“š Conhecimentos migrados:', db.conhecimentos.length);
            }

            // Migrar listas
            if (p.listas && p.listas.length > 0) {
                db.listas = p.listas;
            }

            // Migrar WhatsApp
            if (p.whatsapp) {
                db.whatsapp = {
                    numero: p.whatsapp.numeroVinculado || p.whatsapp.numero || '5518996540492',
                    nome: p.whatsapp.nomeExibicao || p.whatsapp.nome || 'Anderson Enside',
                    webhook: p.whatsapp.webhook || '',
                    conversas: p.whatsapp.conversas || [],
                    mensagens: p.whatsapp.mensagens || 0,
                    chatsAnalisados: p.whatsapp.chatsAnalisados || 0
                };
            }

            // Migrar agente
            if (p.agente) {
                db.agente = {
                    nivel: p.agente.nivel || 1,
                    xp: p.agente.xp || 0,
                    precisao: p.agente.precisao || 50,
                    interacoes: p.agente.interacoes || 0,
                    imports: p.agente.imports || 0,
                    historico: p.agente.historico || []
                };
            }

            // Config
            if (p.config) {
                db.config.googleWebApp = p.config.googleWebApp || '';
                db.config.ultimaSync = p.config.ultimaSync || null;
            }

            // Mostrar alerta de migraÃ§Ã£o
            if (migrou) {
                const total = db.motoristas.length + db.fornecedores.length + db.clientes.length;
                document.getElementById('alertaMigracao').innerHTML =
                    '<div class="alert success">âœ… <strong>Dados migrados!</strong> ' + total + ' contatos e ' + db.conhecimentos.length + ' conhecimentos carregados.</div>';
                db.config.migrado = true;
            }

            console.log('âœ… DB carregado:', {
                motoristas: db.motoristas.length,
                fornecedores: db.fornecedores.length,
                clientes: db.clientes.length,
                conhecimentos: db.conhecimentos.length,
                conversas: db.whatsapp.conversas.length
            });
        }
    } catch(e) {
        console.error('Erro ao carregar:', e);
    }
}

function salvarDB() {
    try {
        localStorage.setItem('enside_db_v5', JSON.stringify(db));
        atualizarTudo();
    } catch(e) {
        console.error('Erro ao salvar:', e);
    }
}

function atualizarTudo() {
    const total = db.motoristas.length + db.fornecedores.length + db.clientes.length;
    const waTotal = [...db.motoristas, ...db.fornecedores, ...db.clientes].filter(c => c.whatsapp).length;

    // Stats
    document.getElementById('sTotal').textContent = total.toLocaleString();
    document.getElementById('sMot').textContent = db.motoristas.length.toLocaleString();
    document.getElementById('sFor').textContent = db.fornecedores.length.toLocaleString();
    document.getElementById('sCli').textContent = db.clientes.length.toLocaleString();
    document.getElementById('sWa').textContent = waTotal.toLocaleString();
    document.getElementById('sConh').textContent = db.conhecimentos.length;

    // Badges
    document.getElementById('badgeMot').textContent = db.motoristas.length;
    document.getElementById('badgeFor').textContent = db.fornecedores.length;
    document.getElementById('badgeCli').textContent = db.clientes.length;
    document.getElementById('badgeConh').textContent = db.conhecimentos.length;

    // Tabela anÃ¡lise
    const calcStats = arr => ({
        wa: arr.filter(r => r.whatsapp).length,
        comp: arr.filter(r => r.nome && (r.telefone || r.whatsapp)).length
    });
    const m = calcStats(db.motoristas), f = calcStats(db.fornecedores), c = calcStats(db.clientes);
    document.getElementById('tblAnalise').innerHTML = `
        <tr><td>ğŸšš Motoristas</td><td>${db.motoristas.length}</td><td>${m.wa}</td><td>${m.comp}</td></tr>
        <tr><td>ğŸ“¦ Fornecedores</td><td>${db.fornecedores.length}</td><td>${f.wa}</td><td>${f.comp}</td></tr>
        <tr><td>ğŸ‘¥ Clientes</td><td>${db.clientes.length}</td><td>${c.wa}</td><td>${c.comp}</td></tr>
        <tr style="font-weight:bold;background:#f5f5f5"><td>TOTAL</td><td>${total}</td><td>${m.wa+f.wa+c.wa}</td><td>${m.comp+f.comp+c.comp}</td></tr>
    `;

    // Agente
    const nivel = Math.floor(db.agente.xp / 100) + 1;
    db.agente.nivel = nivel;
    const aprendizado = Math.min(10 + (db.conhecimentos.length * 5) + (db.agente.interacoes * 2) + (db.agente.imports * 3), 100);
    const precisao = Math.min(50 + (db.conhecimentos.length * 3) + (db.agente.imports * 2), 98);
    db.agente.precisao = precisao;
    const nivelTexto = aprendizado < 20 ? 'Iniciante' : aprendizado < 40 ? 'Aprendiz' : aprendizado < 60 ? 'IntermediÃ¡rio' : aprendizado < 80 ? 'AvanÃ§ado' : 'Expert';

    document.getElementById('dashNivel').textContent = nivel;
    document.getElementById('dashXP').textContent = db.agente.xp;
    document.getElementById('dashPrecisao').textContent = precisao + '%';
    document.getElementById('dashConv').textContent = db.whatsapp.conversas.length;
    document.getElementById('dashProgress').style.width = aprendizado + '%';
    document.getElementById('dashProgressText').textContent = aprendizado + '% - ' + nivelTexto;

    document.getElementById('agNivel').textContent = nivel;
    document.getElementById('agXP').textContent = db.agente.xp;
    document.getElementById('agPrecisao').textContent = precisao + '%';
    document.getElementById('agConh').textContent = db.conhecimentos.length;

    // WhatsApp
    document.getElementById('waNumero').value = db.whatsapp.numero;
    document.getElementById('waNome').value = db.whatsapp.nome;
    document.getElementById('waWebhook').value = db.whatsapp.webhook || '';
    document.getElementById('waConv').textContent = db.whatsapp.conversas.length;
    document.getElementById('waMsgs').textContent = db.whatsapp.mensagens;
    document.getElementById('waAprend').textContent = Math.floor(db.whatsapp.chatsAnalisados * 3);

    // Conhecimentos
    document.getElementById('contConh').textContent = db.conhecimentos.length;

    // Google
    document.getElementById('googleWebApp').value = db.config.googleWebApp || '';

    popularFiltrosUF();
}

function popularFiltrosUF() {
    const ufs = new Set();
    [...db.motoristas, ...db.fornecedores, ...db.clientes].forEach(c => {
        if (c.estado || c.uf) ufs.add((c.estado || c.uf).toUpperCase());
    });

    ['filtroUFMot', 'filtroUFFor', 'filtroUFCli', 'listaFiltroUF'].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        const val = el.value;
        el.innerHTML = '<option value="">Todos UF</option>';
        [...ufs].sort().forEach(uf => el.innerHTML += '<option value="' + uf + '">' + uf + '</option>');
        el.value = val;
    });
}

// TRIAGEM INTELIGENTE
function triagemInteligente(r) {
    const nome = (r.nome || '').toLowerCase();
    const tipo = (r.tipo || '').toLowerCase();
    const setor = (r.setor || '').toLowerCase();
    const texto = nome + ' ' + tipo + ' ' + setor;

    // 1Âº MOTORISTAS/FRETES
    if (/frete|motorista|transportadora|caminhao|caminhÃ£o|carreta|truck|transp|logist|entrega|veiculo|veÃ­culo|frota|driver|bi-?trem|rodotrem/i.test(texto)) {
        return 'motoristas';
    }

    // 2Âº FORNECEDORES
    if (/madeireira|serraria|marcenaria|carpintaria|movelaria|fÃ¡brica|fabrica|industria|indÃºstria|laminadora|compensados|mdf|mdp|eucalipto|pinus|tora|serrada|beneficiamento|fornecedor|supplier/i.test(texto)) {
        return 'fornecedores';
    }

    // 3Âº CLIENTES (resto)
    return 'clientes';
}

// IMPORTAÃ‡ÃƒO
function importarArquivo(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = ev => processarArquivo(ev.target.result, file.name);
    reader.readAsText(file);
}

function processarArquivo(conteudo, nomeArquivo) {
    try {
        let linhas;
        const ext = nomeArquivo.toLowerCase().split('.').pop();

        if (ext === 'json') {
            const data = JSON.parse(conteudo);
            if (Array.isArray(data)) {
                linhas = data;
            } else if (data.motoristas || data.fornecedores || data.clientes) {
                if (confirm('Backup detectado. Restaurar?')) {
                    Object.assign(db, data);
                    salvarDB();
                    document.getElementById('alertaImport').innerHTML = '<div class="alert success">âœ… Backup restaurado!</div>';
                }
                return;
            }
        } else {
            const raw = conteudo.trim().split('\n');
            const sep = raw[0].includes(';') ? ';' : raw[0].includes('\t') ? '\t' : ',';
            const headers = raw[0].split(sep).map(h => h.trim().toLowerCase().replace(/"/g, '').replace(/\s+/g, '_'));

            linhas = raw.slice(1).map(linha => {
                const vals = linha.split(sep).map(v => v.trim().replace(/^"|"$/g, ''));
                const obj = {};
                headers.forEach((h, i) => obj[h] = vals[i] || '');
                return obj;
            });
        }

        const preview = { motoristas: [], fornecedores: [], clientes: [] };

        linhas.forEach(r => {
            const registro = {
                nome: r.nome || r.name || r.razao_social || r.empresa || r.cliente || r.fornecedor || r.contato || '',
                telefone: r.telefone || r.phone || r.tel || r.fone || '',
                whatsapp: r.whatsapp || r.wa || r.wpp || r.celular || r.telefone || '',
                email: r.email || r.mail || '',
                cidade: r.cidade || r.city || r.municipio || '',
                estado: (r.estado || r.uf || r.state || '').toUpperCase(),
                setor: r.setor || r.segmento || '',
                tipo: r.tipo || r.type || r.categoria || ''
            };

            if (!registro.nome || registro.nome.length < 2) return;

            const cat = triagemInteligente(registro);
            registro.id = Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            registro.categoria = cat;
            registro.dataImport = new Date().toLocaleDateString('pt-BR');

            preview[cat].push(registro);
        });

        dadosPendentes = preview;
        document.getElementById('prevMot').textContent = preview.motoristas.length;
        document.getElementById('prevFor').textContent = preview.fornecedores.length;
        document.getElementById('prevCli').textContent = preview.clientes.length;
        document.getElementById('triagemPreview').style.display = 'block';
        document.getElementById('alertaImport').innerHTML = '<div class="alert info">ğŸ§  ' + linhas.length + ' registros analisados.</div>';

    } catch(err) {
        document.getElementById('alertaImport').innerHTML = '<div class="alert error">âŒ Erro: ' + err.message + '</div>';
    }
}

function confirmarImportacao() {
    if (!dadosPendentes) return;

    let stats = { novos: 0, dup: 0 };

    ['motoristas', 'fornecedores', 'clientes'].forEach(cat => {
        dadosPendentes[cat].forEach(reg => {
            const nomeNorm = reg.nome.toLowerCase().trim();
            if (db[cat].some(x => (x.nome || '').toLowerCase().trim() === nomeNorm)) {
                stats.dup++;
                return;
            }
            db[cat].push(reg);
            stats.novos++;
        });
    });

    db.agente.imports++;
    db.agente.xp += Math.floor(stats.novos / 10) + 10;
    salvarDB();

    document.getElementById('triagemPreview').style.display = 'none';
    document.getElementById('alertaImport').innerHTML = '<div class="alert success">âœ… ' + stats.novos + ' importados!' + (stats.dup > 0 ? ' (' + stats.dup + ' duplicados ignorados)' : '') + '</div>';
    dadosPendentes = null;
    document.getElementById('fileInput').value = '';

    addMsgAgente('ğŸ“¥ Importei ' + stats.novos + ' contatos!');
}

function cancelarImportacao() {
    dadosPendentes = null;
    document.getElementById('triagemPreview').style.display = 'none';
}

// CADASTRO
function salvarCadastro() {
    const cat = document.getElementById('cadCategoria').value;
    const nome = document.getElementById('cadNome').value.trim();

    if (!nome) {
        document.getElementById('alertaCad').innerHTML = '<div class="alert error">âŒ Nome obrigatÃ³rio!</div>';
        return;
    }

    if (db[cat].some(x => (x.nome || '').toLowerCase() === nome.toLowerCase())) {
        document.getElementById('alertaCad').innerHTML = '<div class="alert error">âŒ JÃ¡ existe!</div>';
        return;
    }

    const registro = {
        id: Date.now() + '-' + Math.random().toString(36).substr(2, 9),
        nome,
        telefone: document.getElementById('cadTelefone').value.trim(),
        whatsapp: document.getElementById('cadWhatsapp').value.trim(),
        email: document.getElementById('cadEmail').value.trim(),
        cidade: document.getElementById('cadCidade').value.trim(),
        estado: document.getElementById('cadUF').value.trim().toUpperCase(),
        cep: document.getElementById('cadCEP').value.trim(),
        documento: document.getElementById('cadDocumento').value.trim(),
        contato: document.getElementById('cadContato').value.trim(),
        tipoCarga: document.getElementById('cadTipoCarga').value,
        regiao: document.getElementById('cadRegiao').value.trim(),
        origem: document.getElementById('cadOrigem').value.trim(),
        destino: document.getElementById('cadDestino').value.trim(),
        capacidade: document.getElementById('cadCapacidade').value,
        valorFrete: document.getElementById('cadValorFrete').value,
        rotas: document.getElementById('cadRotas').value.trim(),
        tipoVeiculo: document.getElementById('cadTipoVeiculo').value,
        placa: document.getElementById('cadPlaca').value.trim(),
        marca: document.getElementById('cadMarca').value.trim(),
        modelo: document.getElementById('cadModelo').value.trim(),
        ano: document.getElementById('cadAno').value,
        rntrc: document.getElementById('cadRNTRC').value.trim(),
        cnh: document.getElementById('cadCNH').value.trim(),
        formaPagamento: document.getElementById('cadFormaPagamento').value,
        prazoPagamento: document.getElementById('cadPrazoPagamento').value,
        banco: document.getElementById('cadBanco').value.trim(),
        agencia: document.getElementById('cadAgencia').value.trim(),
        conta: document.getElementById('cadConta').value.trim(),
        pix: document.getElementById('cadPix').value.trim(),
        obs: document.getElementById('cadObs').value.trim(),
        categoria: cat,
        dataCadastro: new Date().toLocaleDateString('pt-BR')
    };

    db[cat].push(registro);
    db.agente.xp += 15;
    salvarDB();

    // Limpar formulÃ¡rio
    ['cadNome', 'cadTelefone', 'cadWhatsapp', 'cadEmail', 'cadCidade', 'cadUF', 'cadCEP', 'cadDocumento', 'cadContato', 'cadRegiao', 'cadOrigem', 'cadDestino', 'cadCapacidade', 'cadValorFrete', 'cadRotas', 'cadPlaca', 'cadMarca', 'cadModelo', 'cadAno', 'cadRNTRC', 'cadCNH', 'cadBanco', 'cadAgencia', 'cadConta', 'cadPix', 'cadObs'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
    });

    document.getElementById('alertaCad').innerHTML = '<div class="alert success">âœ… Cadastro salvo!</div>';
    addMsgAgente('âœ… Cadastrei ' + nome + ' como ' + (cat === 'motoristas' ? 'ğŸšš motorista' : cat === 'fornecedores' ? 'ğŸ“¦ fornecedor' : 'ğŸ‘¥ cliente') + '!');
}

// RENDERIZAÃ‡ÃƒO DE LISTAS
function renderLista(arr, elId, icon, badgeClass) {
    const el = document.getElementById(elId);
    if (!arr.length) {
        el.innerHTML = '<div class="alert info">Nenhum registro</div>';
        return;
    }

    el.innerHTML = arr.slice(0, 100).map(c => `
        <div class="card">
            <div class="card-header">
                <div style="font-weight:600;">${icon} ${c.nome}</div>
                <div>
                    ${c.tipoVeiculo ? '<span class="card-badge badge-motorista">' + c.tipoVeiculo + '</span>' : ''}
                    ${c.estado ? '<span class="card-badge ' + badgeClass + '">' + c.estado + '</span>' : ''}
                </div>
            </div>
            ${c.telefone ? '<div class="card-field">â˜ï¸ ' + c.telefone + '</div>' : ''}
            ${c.whatsapp ? '<div class="card-field">ğŸ“± <a href="https://wa.me/55' + c.whatsapp.replace(/\D/g, '') + '" target="_blank">' + c.whatsapp + '</a></div>' : ''}
            ${c.cidade ? '<div class="card-field">ğŸ“ ' + c.cidade + (c.estado ? ' - ' + c.estado : '') + '</div>' : ''}
            ${c.rotas ? '<div class="card-field">ğŸ›£ï¸ ' + c.rotas + '</div>' : ''}
            <button onclick="excluir('${c.categoria}','${c.id}')" class="btn-small btn-danger">ğŸ—‘ï¸</button>
        </div>
    `).join('');

    if (arr.length > 100) el.innerHTML += '<div class="alert info">Mostrando 100 de ' + arr.length + '</div>';
}

function filtrarMotoristas() {
    const busca = document.getElementById('buscaMot').value.toLowerCase();
    const tipo = document.getElementById('filtroTipoMot').value;
    const uf = document.getElementById('filtroUFMot').value;
    const filtered = db.motoristas.filter(c =>
        (!busca || c.nome.toLowerCase().includes(busca) || (c.cidade || '').toLowerCase().includes(busca)) &&
        (!tipo || c.tipoVeiculo === tipo) &&
        (!uf || c.estado === uf)
    );
    renderLista(filtered, 'listaMot', 'ğŸšš', 'badge-motorista');
}

function filtrarFornecedores() {
    const busca = document.getElementById('buscaFor').value.toLowerCase();
    const uf = document.getElementById('filtroUFFor').value;
    const filtered = db.fornecedores.filter(c =>
        (!busca || c.nome.toLowerCase().includes(busca)) && (!uf || c.estado === uf)
    );
    renderLista(filtered, 'listaFor', 'ğŸ“¦', 'badge-fornecedor');
}

function filtrarClientes() {
    const busca = document.getElementById('buscaCli').value.toLowerCase();
    const uf = document.getElementById('filtroUFCli').value;
    const filtered = db.clientes.filter(c =>
        (!busca || c.nome.toLowerCase().includes(busca)) && (!uf || c.estado === uf)
    );
    renderLista(filtered, 'listaCli', 'ğŸ‘¥', 'badge-cliente');
}

function excluir(cat, id) {
    if (!confirm('Excluir?')) return;
    db[cat] = db[cat].filter(c => c.id !== id);
    salvarDB();
    if (cat === 'motoristas') filtrarMotoristas();
    else if (cat === 'fornecedores') filtrarFornecedores();
    else filtrarClientes();
}

// LISTAS DE TRANSMISSÃƒO
function previewLista() {
    const tipo = document.getElementById('listaFiltroTipo').value;
    const uf = document.getElementById('listaFiltroUF').value;

    let contatos = [];
    if (tipo) contatos = db[tipo].filter(c => c.whatsapp);
    else contatos = [...db.motoristas, ...db.fornecedores, ...db.clientes].filter(c => c.whatsapp);

    contatos = contatos.filter(c => !uf || c.estado === uf);

    const numListas = Math.ceil(contatos.length / 256);
    const el = document.getElementById('previewListaInfo');
    el.style.display = 'block';
    el.innerHTML = 'ğŸ“Š <strong>' + contatos.length + '</strong> contatos com WhatsApp<br>ğŸ“± SerÃ£o criadas <strong>' + numListas + '</strong> lista(s)';
}

function criarLista() {
    const nome = document.getElementById('listaNome').value.trim();
    if (!nome) { document.getElementById('alertaLista').innerHTML = '<div class="alert error">âŒ Nome obrigatÃ³rio!</div>'; return; }

    const tipo = document.getElementById('listaFiltroTipo').value;
    const uf = document.getElementById('listaFiltroUF').value;

    let contatos = [];
    if (tipo) contatos = db[tipo].filter(c => c.whatsapp);
    else contatos = [...db.motoristas, ...db.fornecedores, ...db.clientes].filter(c => c.whatsapp);

    contatos = contatos.filter(c => !uf || c.estado === uf);

    if (!contatos.length) { document.getElementById('alertaLista').innerHTML = '<div class="alert error">âŒ Nenhum contato!</div>'; return; }

    const chunks = [];
    for (let i = 0; i < contatos.length; i += 256) chunks.push(contatos.slice(i, i + 256));

    chunks.forEach((chunk, idx) => {
        db.listas.push({
            id: Date.now() + '-' + Math.random().toString(36).substr(2, 9),
            nome: chunks.length > 1 ? nome + ' (' + (idx + 1) + '/' + chunks.length + ')' : nome,
            contatos: chunk.map(c => ({ id: c.id, nome: c.nome, whatsapp: c.whatsapp })),
            total: chunk.length,
            criado: new Date().toLocaleDateString('pt-BR')
        });
    });

    db.agente.xp += 20;
    salvarDB();

    document.getElementById('alertaLista').innerHTML = '<div class="alert success">âœ… ' + chunks.length + ' lista(s) criada(s)!</div>';
    document.getElementById('listaNome').value = '';
    document.getElementById('previewListaInfo').style.display = 'none';
    renderMinhasListas();
}

function renderMinhasListas() {
    const el = document.getElementById('minhasListas');
    if (!db.listas.length) { el.innerHTML = '<div class="alert info">Nenhuma lista</div>'; return; }

    el.innerHTML = db.listas.map(l => `
        <div class="list-item">
            <div>
                <strong>ğŸ“‹ ${l.nome}</strong>
                <p style="font-size:0.8em;color:#666;">Criada: ${l.criado}</p>
            </div>
            <div style="display:flex;gap:8px;align-items:center;">
                <span class="list-count">${l.total}</span>
                <button onclick="exportarLista('${l.id}')" class="btn-small btn-whatsapp">ğŸ“±</button>
                <button onclick="excluirLista('${l.id}')" class="btn-small btn-danger">ğŸ—‘ï¸</button>
            </div>
        </div>
    `).join('');
}

function exportarLista(id) {
    const lista = db.listas.find(l => l.id === id);
    if (!lista) return;
    let csv = 'Nome,WhatsApp\n';
    lista.contatos.forEach(c => csv += '"' + c.nome + '","' + c.whatsapp + '"\n');
    download(csv, 'lista_' + lista.nome.replace(/[^a-zA-Z0-9]/g, '_') + '.csv');
}

function excluirLista(id) {
    if (!confirm('Excluir lista?')) return;
    db.listas = db.listas.filter(l => l.id !== id);
    salvarDB();
    renderMinhasListas();
}

// CONHECIMENTOS - CRÃTICO!
function salvarConhecimento() {
    const titulo = document.getElementById('conhTitulo').value.trim();
    const conteudo = document.getElementById('conhConteudo').value.trim();

    if (!titulo || !conteudo) {
        document.getElementById('alertaConh').innerHTML = '<div class="alert error">âŒ TÃ­tulo e conteÃºdo obrigatÃ³rios!</div>';
        return;
    }

    db.conhecimentos.push({
        id: Date.now(),
        titulo,
        categoria: document.getElementById('conhCategoria').value,
        conteudo,
        tags: document.getElementById('conhTags').value.split(',').map(t => t.trim().toLowerCase()).filter(t => t),
        criado: new Date().toLocaleDateString('pt-BR')
    });

    db.agente.xp += 15;
    salvarDB();

    document.getElementById('conhTitulo').value = '';
    document.getElementById('conhConteudo').value = '';
    document.getElementById('conhTags').value = '';
    document.getElementById('alertaConh').innerHTML = '<div class="alert success">âœ… Conhecimento salvo!</div>';
    renderConhecimentos();
    addMsgAgente('ğŸ“š Aprendi sobre "' + titulo + '"! Agora posso responder sobre isso.');
}

function renderConhecimentos() {
    const busca = document.getElementById('buscaConh')?.value?.toLowerCase() || '';
    const el = document.getElementById('listaConh');

    let filtered = db.conhecimentos;
    if (busca) {
        filtered = filtered.filter(c =>
            c.titulo.toLowerCase().includes(busca) ||
            c.conteudo.toLowerCase().includes(busca) ||
            c.tags.some(t => t.includes(busca))
        );
    }

    if (!filtered.length) {
        el.innerHTML = '<div class="alert info">Nenhum conhecimento' + (busca ? ' encontrado' : '') + '</div>';
        return;
    }

    el.innerHTML = filtered.map(c => `
        <div class="knowledge-card">
            <h4>ğŸ“– ${c.titulo}</h4>
            <p>${c.conteudo}</p>
            ${c.tags.length ? '<div class="knowledge-tags">' + c.tags.map(t => '<span class="knowledge-tag">' + t + '</span>').join('') + '</div>' : ''}
            <button onclick="excluirConhecimento(${c.id})" class="btn-small btn-danger" style="margin-top:8px;">ğŸ—‘ï¸</button>
        </div>
    `).join('');
}

function filtrarConhecimentos() {
    renderConhecimentos();
}

function excluirConhecimento(id) {
    if (!confirm('Excluir conhecimento?')) return;
    db.conhecimentos = db.conhecimentos.filter(c => c.id !== id);
    salvarDB();
    renderConhecimentos();
}

// BUSCA EM CONHECIMENTOS - AGENTE IA
function buscarConhecimento(pergunta) {
    if (!db.conhecimentos.length) return null;

    const palavras = pergunta.toLowerCase().split(/\s+/).filter(p => p.length > 2);
    let melhorMatch = null;
    let melhorScore = 0;

    db.conhecimentos.forEach(c => {
        let score = 0;
        const tituloLower = c.titulo.toLowerCase();
        const conteudoLower = c.conteudo.toLowerCase();

        // Busca por tÃ­tulo
        palavras.forEach(p => {
            if (tituloLower.includes(p)) score += 10;
            if (conteudoLower.includes(p)) score += 5;
        });

        // Busca por tags
        c.tags.forEach(tag => {
            palavras.forEach(p => {
                if (tag.includes(p) || p.includes(tag)) score += 8;
            });
        });

        if (score > melhorScore) {
            melhorScore = score;
            melhorMatch = c;
        }
    });

    return melhorScore > 5 ? melhorMatch : null;
}

function processarPergunta(msg) {
    const msgLower = msg.toLowerCase();

    // PRIMEIRO: Buscar nos conhecimentos
    const conhecimento = buscarConhecimento(msg);
    if (conhecimento) {
        return 'ğŸ“– <strong>' + conhecimento.titulo + '</strong><br><br>' + conhecimento.conteudo;
    }

    // Respostas padrÃ£o
    if (msgLower.includes('resumo') || msgLower.includes('status')) {
        const total = db.motoristas.length + db.fornecedores.length + db.clientes.length;
        return 'ğŸ“Š <strong>Resumo:</strong><br>ğŸšš ' + db.motoristas.length + ' motoristas<br>ğŸ“¦ ' + db.fornecedores.length + ' fornecedores<br>ğŸ‘¥ ' + db.clientes.length + ' clientes<br>ğŸ“š ' + db.conhecimentos.length + ' conhecimentos<br>ğŸ“± ' + db.whatsapp.conversas.length + ' conversas';
    }

    if (msgLower.includes('quantos') && msgLower.includes('motorista')) {
        return 'ğŸšš VocÃª tem ' + db.motoristas.length + ' motoristas cadastrados.';
    }

    if (msgLower.includes('quantos') && msgLower.includes('fornecedor')) {
        return 'ğŸ“¦ VocÃª tem ' + db.fornecedores.length + ' fornecedores cadastrados.';
    }

    if (msgLower.includes('quantos') && msgLower.includes('cliente')) {
        return 'ğŸ‘¥ VocÃª tem ' + db.clientes.length + ' clientes cadastrados.';
    }

    if (msgLower.includes('ajuda') || msgLower.includes('comandos')) {
        return 'ğŸ’¡ <strong>Comandos:</strong><br>â€¢ "resumo" - ver estatÃ­sticas<br>â€¢ "quantos motoristas/fornecedores/clientes"<br>â€¢ Pergunte sobre preÃ§os, fretes, rotas...<br>â€¢ Adicione conhecimentos na aba ğŸ“š';
    }

    return 'ğŸ¤” NÃ£o encontrei informaÃ§Ã£o sobre isso. Adicione um conhecimento na aba ğŸ“š para eu aprender!';
}

function enviarMsg() {
    const input = document.getElementById('chatIn');
    const msg = input.value.trim();
    if (!msg) return;

    const chatEl = document.getElementById('chatMsgs');
    chatEl.innerHTML += '<div class="chat-msg user">' + msg + '<div class="time">' + new Date().toLocaleTimeString('pt-BR', {hour:'2-digit',minute:'2-digit'}) + '</div></div>';
    input.value = '';

    db.agente.interacoes++;
    db.agente.xp += 2;

    document.getElementById('agTyping').style.display = 'inline';

    setTimeout(() => {
        document.getElementById('agTyping').style.display = 'none';
        const resposta = processarPergunta(msg);
        addMsgAgente(resposta);
        salvarDB();
    }, 500);
}

function addMsgAgente(msg) {
    const chatEl = document.getElementById('chatMsgs');
    chatEl.innerHTML += '<div class="chat-msg agent">' + msg + '<div class="time">' + new Date().toLocaleTimeString('pt-BR', {hour:'2-digit',minute:'2-digit'}) + '</div></div>';
    chatEl.scrollTop = chatEl.scrollHeight;
}

// WHATSAPP
function salvarWhatsApp() {
    db.whatsapp.numero = document.getElementById('waNumero').value.replace(/\D/g, '');
    db.whatsapp.nome = document.getElementById('waNome').value.trim();
    salvarDB();
    alert('âœ… WhatsApp salvo!');
}

function salvarWebhook() {
    db.whatsapp.webhook = document.getElementById('waWebhook').value.trim();
    salvarDB();
    alert('âœ… Webhook salvo!');
}

function testarWebhook() {
    addMsgAgente('ğŸ§ª Webhook testado! (simulaÃ§Ã£o)');
}

function simularConversa() {
    const nomes = ['JoÃ£o Madeireira', 'Maria Transportes', 'Carlos Frete', 'Pedro MÃ³veis', 'Ana Pinus'];
    const msgs = ['Tem frete SP-PR?', 'Qual preÃ§o pinus?', 'Preciso de caminhÃ£o', 'Entrega quando?', 'Faz MDF?'];

    const conv = {
        id: Date.now(),
        contato: nomes[Math.floor(Math.random() * nomes.length)],
        telefone: '5518' + Math.random().toString().slice(2, 11),
        msg: msgs[Math.floor(Math.random() * msgs.length)],
        hora: new Date().toLocaleTimeString('pt-BR', {hour:'2-digit',minute:'2-digit'}),
        data: new Date().toLocaleDateString('pt-BR')
    };

    db.whatsapp.conversas.push(conv);
    db.whatsapp.mensagens++;
    db.whatsapp.chatsAnalisados++;
    db.agente.xp += 5;
    salvarDB();

    renderConversas();

    // Buscar resposta nos conhecimentos
    const resposta = buscarConhecimento(conv.msg);
    if (resposta) {
        addMsgAgente('ğŸ“± ' + conv.contato + ': "' + conv.msg + '"<br><br>ğŸ’¡ Resposta sugerida: ' + resposta.conteudo);
    } else {
        addMsgAgente('ğŸ“± Nova conversa de ' + conv.contato + ':<br>"' + conv.msg + '"');
    }
}

function renderConversas() {
    const el = document.getElementById('waConversas');
    if (!db.whatsapp.conversas.length) { el.innerHTML = '<div class="alert info">Nenhuma conversa</div>'; return; }

    el.innerHTML = db.whatsapp.conversas.slice(-10).reverse().map(c => `
        <div style="background:#e5ddd5;padding:10px;border-radius:10px;margin-bottom:8px;">
            <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                <strong style="color:var(--whatsapp);">ğŸ‘¤ ${c.contato}</strong>
                <span style="color:#666;font-size:0.8em;">${c.hora}</span>
            </div>
            <div style="background:white;padding:8px 12px;border-radius:8px;">${c.msg}</div>
        </div>
    `).join('');
}

// GOOGLE SHEETS
function sincronizarGoogle() {
    const url = document.getElementById('googleWebApp').value.trim();
    if (!url) {
        document.getElementById('alertaGoogle').innerHTML = '<div class="alert error">âŒ Configure a URL do Web App primeiro!</div>';
        return;
    }

    db.config.googleWebApp = url;

    fetch(url)
        .then(r => r.json())
        .then(data => {
            let importados = 0;
            data.forEach(row => {
                const registro = {
                    id: Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                    nome: row['Cliente'] || row['Nome'] || row['CLIENTE'] || '',
                    telefone: row['Telefone'] || row['TELEFONE'] || '',
                    whatsapp: row['Telefone'] || row['WhatsApp'] || '',
                    cidade: row['Cidade'] || row['CIDADE'] || '',
                    estado: row['UF'] || row['Estado'] || '',
                    contato: row['Contato'] || row['CONTATO'] || '',
                    dataCadastro: new Date().toLocaleDateString('pt-BR')
                };

                if (registro.nome && registro.nome.length > 2) {
                    const cat = triagemInteligente(registro);
                    registro.categoria = cat;
                    if (!db[cat].some(x => x.nome.toLowerCase() === registro.nome.toLowerCase())) {
                        db[cat].push(registro);
                        importados++;
                    }
                }
            });

            db.config.ultimaSync = new Date().toISOString();
            salvarDB();
            document.getElementById('alertaGoogle').innerHTML = '<div class="alert success">âœ… Sincronizado! ' + importados + ' novos registros.</div>';
            addMsgAgente('ğŸ“Š Sincronizei ' + importados + ' registros do Google Sheets!');
        })
        .catch(err => {
            document.getElementById('alertaGoogle').innerHTML = '<div class="alert error">âŒ Erro: ' + err.message + '</div>';
        });
}

function enviarParaGoogle() {
    const url = document.getElementById('googleWebApp').value.trim();
    if (!url) {
        document.getElementById('alertaGoogle').innerHTML = '<div class="alert error">âŒ Configure a URL primeiro!</div>';
        return;
    }
    document.getElementById('alertaGoogle').innerHTML = '<div class="alert info">â„¹ï¸ FunÃ§Ã£o de envio requer configuraÃ§Ã£o adicional no Apps Script.</div>';
}

// EXPORTAÃ‡ÃƒO
function exportCSV(cat) {
    let data, headers, filename;

    if (cat === 'conhecimentos') {
        if (!db.conhecimentos.length) { alert('Nenhum conhecimento!'); return; }
        headers = 'Titulo,Categoria,Conteudo,Tags,Criado\n';
        data = db.conhecimentos.map(c => '"' + c.titulo + '","' + c.categoria + '","' + c.conteudo.replace(/"/g, '""') + '","' + c.tags.join('; ') + '","' + c.criado + '"').join('\n');
        filename = 'conhecimentos_enside.csv';
    } else {
        if (!db[cat].length) { alert('Nenhum registro!'); return; }
        headers = 'Nome,Telefone,WhatsApp,Email,Cidade,Estado,Tipo Veiculo,Rotas\n';
        data = db[cat].map(c => '"' + (c.nome || '') + '","' + (c.telefone || '') + '","' + (c.whatsapp || '') + '","' + (c.email || '') + '","' + (c.cidade || '') + '","' + (c.estado || '') + '","' + (c.tipoVeiculo || '') + '","' + (c.rotas || '') + '"').join('\n');
        filename = cat + '_enside.csv';
    }

    download(headers + data, filename);
}

function exportWhatsApp() {
    const todos = [...db.motoristas, ...db.fornecedores, ...db.clientes].filter(c => c.whatsapp);
    if (!todos.length) { alert('Nenhum WhatsApp!'); return; }
    let csv = 'Nome,WhatsApp,Categoria\n';
    todos.forEach(c => csv += '"' + c.nome + '","' + c.whatsapp + '","' + c.categoria + '"\n');
    download(csv, 'whatsapp_todos.csv');
}

function exportJSON() {
    download(JSON.stringify(db, null, 2), 'enside_backup_v6.15_' + new Date().toISOString().slice(0, 10) + '.json');
}

function download(content, filename) {
    const a = document.createElement('a');
    a.href = 'data:text/plain;charset=utf-8,' + encodeURIComponent(content);
    a.download = filename;
    a.click();
}

function limparTudo() {
    if (!confirm('âš ï¸ APAGAR TODOS OS DADOS?')) return;
    if (!confirm('ğŸš¨ CERTEZA ABSOLUTA?')) return;
    localStorage.removeItem('enside_db_v5');
    location.reload();
}

// NAVEGAÃ‡ÃƒO
function abrirAba(id, btn) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    btn.classList.add('active');

    if (id === 'motoristas') filtrarMotoristas();
    if (id === 'fornecedores') filtrarFornecedores();
    if (id === 'clientes') filtrarClientes();
    if (id === 'listas') { previewLista(); renderMinhasListas(); }
    if (id === 'conhecimentos') renderConhecimentos();
    if (id === 'whatsapp') renderConversas();
}

function abrirInner(id, btn) {
    const parent = btn.closest('.panel');
    parent.querySelectorAll('.inner-content').forEach(el => el.classList.remove('active'));
    parent.querySelectorAll('.inner-tab').forEach(el => el.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    btn.classList.add('active');
}

// Drag & Drop
document.addEventListener('DOMContentLoaded', () => {
    const dropZone = document.getElementById('dropZone');
    if (dropZone) {
        ['dragenter', 'dragover'].forEach(e => dropZone.addEventListener(e, ev => { ev.preventDefault(); dropZone.classList.add('dragover'); }));
        ['dragleave', 'drop'].forEach(e => dropZone.addEventListener(e, ev => { ev.preventDefault(); dropZone.classList.remove('dragover'); }));
        dropZone.addEventListener('drop', ev => {
            const file = ev.dataTransfer.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => processarArquivo(e.target.result, file.name);
                reader.readAsText(file);
            }
        });
    }
});

// INICIALIZAÃ‡ÃƒO
carregarDB();
atualizarTudo();
renderConhecimentos();
renderMinhasListas();
renderConversas();

setTimeout(() => {
    const total = db.motoristas.length + db.fornecedores.length + db.clientes.length;
    let msgInicial = 'ğŸ‘‹ OlÃ¡ Anderson! Sou <strong>Enside Agent v6.15 ULTRA</strong>.<br><br>';
    msgInicial += 'ğŸ“Š ' + total + ' contatos | ğŸ“š ' + db.conhecimentos.length + ' conhecimentos<br>';
    msgInicial += 'ğŸ“± WhatsApp: ' + db.whatsapp.numero + '<br><br>';
    msgInicial += 'ğŸ’¡ Pergunte algo! Busco nos conhecimentos primeiro.';
    addMsgAgente(msgInicial);
}, 500);

console.log('âœ… ENSIDE DATABASE v6.15 ULTRA COMPLETO - PRONTO!');
console.log('ğŸ“Š Planilha: 1NJRMB-pgEFS0MjtKrh2mhqPN6apkDwwJMAPOCejLX8Y');
console.log('ğŸ“± WhatsApp: 5518996540492');
console.log('ğŸ’¾ localStorage: enside_db_v5');
</script>
</body>
</html>
