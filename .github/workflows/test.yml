name: Tests

on:
  push:
    branches: [ "main", "claude/**" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  # Job 1: Configuration and Workflow Tests (Jest)
  config-tests:
    name: Configuration Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run configuration tests
        run: npm run test:config

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        if: always()
        with:
          files: ./coverage/lcov.info
          flags: config
          name: config-coverage

  # Job 2: Shell Script Tests (Bats)
  shell-tests:
    name: Shell Script Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install bats
        run: |
          sudo apt-get update
          sudo apt-get install -y bats

      - name: Install bats-support and bats-assert
        run: |
          mkdir -p tests/test_helper
          git clone https://github.com/bats-core/bats-support.git tests/test_helper/bats-support
          git clone https://github.com/bats-core/bats-assert.git tests/test_helper/bats-assert

      - name: Make init-firewall.sh executable
        run: chmod +x .devcontainer/init-firewall.sh

      - name: Run shell script tests
        run: bats tests/shell/

      - name: Test results
        if: always()
        run: echo "Shell tests completed"

  # Job 3: Lint YAML files
  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint YAML files
        run: npm run lint:yaml

  # Job 4: Lint Shell scripts
  shell-lint:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install ShellCheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Run ShellCheck
        run: npm run lint:shell

  # Job 5: GitHub Actions Tests
  action-tests:
    name: GitHub Actions Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        test:
          - claude-code-action
          - claude-issue-triage
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run ${{ matrix.test }} tests
        run: |
          echo "Running tests for ${{ matrix.test }}"
          # Note: These are workflow files that would run in GitHub Actions
          # We validate they exist and are properly formatted
          test -f "tests/actions/${{ matrix.test }}.test.yml"
          echo "✓ Test workflow exists for ${{ matrix.test }}"

  # Job 6: Validate all workflows are parseable
  validate-workflows:
    name: Validate Workflows
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install -g yaml-validator

      - name: Validate workflow YAML syntax
        run: |
          for file in .github/workflows/*.yml; do
            echo "Validating $file"
            # Basic YAML validation
            python3 -c "import yaml; yaml.safe_load(open('$file'))" || exit 1
          done

      - name: Validate action YAML syntax
        run: |
          for file in .github/actions/*/action.yml; do
            echo "Validating $file"
            python3 -c "import yaml; yaml.safe_load(open('$file'))" || exit 1
          done

  # Job 7: Security checks
  security:
    name: Security Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for secrets in code
        run: |
          # Check for potential hardcoded secrets
          if grep -r -i -E "(password|api_key|secret|token)\s*=\s*['\"][a-zA-Z0-9]{20,}" \
              --exclude-dir=node_modules \
              --exclude-dir=.git \
              --exclude-dir=coverage \
              --exclude="*.test.js" \
              --exclude="*.test.yml" \
              .; then
            echo "::error::Potential hardcoded secrets found!"
            exit 1
          fi
          echo "✓ No hardcoded secrets detected"

      - name: Check for TODO/FIXME in workflows
        run: |
          if grep -r -i -E "(TODO|FIXME)" .github/workflows/; then
            echo "::warning::Found TODO/FIXME comments in workflows"
          fi

  # Job 8: Coverage Summary
  coverage-summary:
    name: Coverage Summary
    runs-on: ubuntu-latest
    needs: [config-tests, shell-tests]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## Test Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Configuration tests completed" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Shell script tests completed" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ YAML validation completed" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Security checks completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All test jobs have completed. Check individual jobs for details." >> $GITHUB_STEP_SUMMARY
