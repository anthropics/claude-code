name: Log Issue Events to Statsig

on:
  issues:
    types: [opened, closed]

jobs:
  log-to-statsig:
    runs-on: ubuntu-latest
    permissions:
      issues: read
    steps:
      - name: Log issue creation to Statsig
        env:
          STATSIG_API_KEY: ${{ secrets.STATSIG_API_KEY }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          REPO: ${{ github.repository }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          AUTHOR: ${{ github.event.issue.user.login }}
          CREATED_AT: ${{ github.event.issue.created_at }}
        run: |
          # Use jq to safely construct JSON, properly escaping all special characters
          JSON_PAYLOAD=$(jq -n \
            --arg issue_num "$ISSUE_NUMBER" \
            --arg repo "$REPO" \
            --arg title "$ISSUE_TITLE" \
            --arg author "$AUTHOR" \
            --arg created "$CREATED_AT" \
            --arg time "$(date +%s)000" \
            '{
              events: [{
                eventName: "github_issue_created",
                metadata: {
                  issue_number: $issue_num,
                  repository: $repo,
                  title: $title,
                  author: $author,
                  created_at: $created
                },
                time: ($time | tonumber)
              }]
            }')

          curl -X POST "https://events.statsigapi.net/v1/log_event" \
            -H "Content-Type: application/json" \
            -H "statsig-api-key: $STATSIG_API_KEY" \
            -d "$JSON_PAYLOAD"