name: "Manage Stale Issues"

on:
  schedule:
    # 2am Pacific = 9am UTC (10am UTC during DST)
    - cron: "0 10 * * *"
  workflow_dispatch:

permissions:
  issues: write

concurrency:
  group: stale-issue-manager

jobs:
  manage-stale-issues:
    runs-on: ubuntu-latest
    steps:
      - name: Manage stale issues
        uses: actions/github-script@v7
        with:
          script: |
            const oneMonthAgo = new Date();
            oneMonthAgo.setDate(oneMonthAgo.getDate() - 30);

            const twoMonthsAgo = new Date();
            twoMonthsAgo.setDate(twoMonthsAgo.getDate() - 60);

            const warningComment = `This issue has been inactive for 30 days. If the issue is still occurring, please comment to let us know. Otherwise, this issue will be automatically closed in 30 days for housekeeping purposes.`;

            const closingComment = `This issue has been automatically closed due to 60 days of inactivity. If you're still experiencing this issue, please open a new issue with updated information.`;

            let page = 1;
            let hasMore = true;
            let totalWarned = 0;
            let totalClosed = 0;
            let totalLabeled = 0;

            while (hasMore) {
              // Get open issues sorted by last updated (oldest first)
              const { data: issues } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                sort: 'updated',
                direction: 'asc',
                per_page: 100,
                page: page
              });
              
              if (issues.length === 0) {
                hasMore = false;
                break;
              }
              
              for (const issue of issues) {
                // Skip if already locked
                if (issue.locked) continue;
                
                // Skip pull requests
                if (issue.pull_request) continue;
                
                // Check if issue has autoclose label
                const hasAutocloseLabel = issue.labels.some(label => 
                  typeof label === 'object' && label.name === 'autoclose'
                );
                
                try {
                  let lastHumanCommentAt = new Date(issue.created_at);
                  let lastWarningCommentAt = null;

                  if (issue.comments > 0) {
                    // Get comments to check for human activity and existing warning
                    const { data: comments } = await github.rest.issues.listComments({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: issue.number,
                      per_page: 100
                    });

                    for (const comment of comments) {
                      if (!comment.user || !comment.user.login) continue;

                      if (comment.user.login === 'github-actions[bot]' &&
                          comment.body && comment.body.includes('inactive for 30 days')) {
                        const warningDate = new Date(comment.created_at);
                        if (!lastWarningCommentAt || warningDate > lastWarningCommentAt) {
                          lastWarningCommentAt = warningDate;
                        }
                      } else if (comment.user.login !== 'github-actions[bot]') {
                        const commentDate = new Date(comment.created_at);
                        if (commentDate > lastHumanCommentAt) {
                          lastHumanCommentAt = commentDate;
                        }
                      }
                    }
                  }

                  const warningIsCurrent = lastWarningCommentAt &&
                    lastWarningCommentAt > lastHumanCommentAt;

                  if (lastHumanCommentAt < twoMonthsAgo) {
                    // Close the issue - it's been inactive for 60+ days
                    console.log(`Closing issue #${issue.number} (inactive for 60+ days): ${issue.title}`);

                    // Post closing comment
                    await github.rest.issues.createComment({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: issue.number,
                      body: closingComment
                    });

                    // Close the issue
                    await github.rest.issues.update({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: issue.number,
                      state: 'closed',
                      state_reason: 'not_planned'
                    });

                    totalClosed++;
                  } else if (lastHumanCommentAt < oneMonthAgo && !warningIsCurrent) {
                    // No current warning yet, issue is 30+ days inactive
                    console.log(`Warning issue #${issue.number} (inactive for 30+ days): ${issue.title}`);

                    // Post warning comment
                    await github.rest.issues.createComment({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: issue.number,
                      body: warningComment
                    });

                    totalWarned++;

                    // Add autoclose label if not present
                    if (!hasAutocloseLabel) {
                      await github.rest.issues.addLabels({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: issue.number,
                        labels: ['autoclose']
                      });
                      totalLabeled++;
                    }
                  }
                } catch (error) {
                  console.error(`Failed to process issue #${issue.number}: ${error.message}`);
                }
              }
              
              page++;
            }

            console.log(`Summary:`);
            console.log(`- Issues warned (30 days stale): ${totalWarned}`);
            console.log(`- Issues labeled with autoclose: ${totalLabeled}`);
            console.log(`- Issues closed (60 days stale): ${totalClosed}`);
