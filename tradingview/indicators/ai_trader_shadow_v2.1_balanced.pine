//@version=5
indicator("AI Trader's Shadow v2.1 BALANCED", overlay=true, max_bars_back=500)

// ============================================================================
// AI TRADER'S SHADOW v2.1 - BALANCED MODE
// ============================================================================
// Description: Enhanced trading signal system with balanced filters
//              Optimized for 5-10 trades/day with improved win rate
// Version: 2.1 BALANCED
// Date: 2024-11-13
// Mode: BALANCED (between CONSERVATIVE and AGGRESSIVE)
//
// Key Improvements from v2.0:
// - Confidence threshold: 0.75 → 0.65 (more signals)
// - Cooldown: 15 bars → 10 bars (faster recovery)
// - Volume filter: 1.3x → 1.1x (more permissive)
// - ATR filter: 0.8x → 0.6x (catch more moves)
// - Range threshold: 3% → 2% (tradeable in tighter ranges)
// - ETH/SOL penalty: 25% → 15% (fairer treatment)
// - Improved adaptive threshold logic
// ============================================================================

// ============================================================================
// CONFIGURATION PANEL
// ============================================================================

// --- MODE SELECTION ---
mode = input.string("BALANCED", "Trading Mode",
     options=["CONSERVATIVE", "BALANCED", "AGGRESSIVE"],
     tooltip="CONSERVATIVE: High confidence, fewer signals\nBALANCED: Optimal signal frequency\nAGGRESSIVE: More signals, higher risk")

// --- CONFIDENCE THRESHOLDS (MODE-DEPENDENT) ---
conservative_threshold = input.float(0.75, "Conservative Min Confidence", minval=0.5, maxval=1.0, step=0.05)
balanced_threshold = input.float(0.65, "Balanced Min Confidence", minval=0.5, maxval=1.0, step=0.05)
aggressive_threshold = input.float(0.55, "Aggressive Min Confidence", minval=0.5, maxval=1.0, step=0.05)

// Get threshold based on mode
min_confidence = mode == "CONSERVATIVE" ? conservative_threshold :
                 mode == "BALANCED" ? balanced_threshold :
                 aggressive_threshold

// --- COOLDOWN SETTINGS ---
conservative_cooldown = input.int(15, "Conservative Cooldown (bars)", minval=1, maxval=50)
balanced_cooldown = input.int(10, "Balanced Cooldown (bars)", minval=1, maxval=50)
aggressive_cooldown = input.int(5, "Aggressive Cooldown (bars)", minval=1, maxval=50)

cooldown_bars = mode == "CONSERVATIVE" ? conservative_cooldown :
                mode == "BALANCED" ? balanced_cooldown :
                aggressive_cooldown

// --- FILTER SETTINGS ---
enable_volume_filter = input.bool(true, "Enable Volume Filter")
enable_atr_filter = input.bool(true, "Enable ATR Filter")
enable_trend_filter = input.bool(true, "Enable Trend Quality Filter")
enable_regime_filter = input.bool(true, "Enable Market Regime Filter")

// --- VOLUME PARAMETERS ---
volume_sma_length = input.int(20, "Volume SMA Length", minval=5, maxval=100)
volume_multiplier_conservative = input.float(1.3, "Volume Multiplier (Conservative)", minval=0.5, maxval=3.0, step=0.1)
volume_multiplier_balanced = input.float(1.1, "Volume Multiplier (Balanced)", minval=0.5, maxval=3.0, step=0.1)
volume_multiplier_aggressive = input.float(0.9, "Volume Multiplier (Aggressive)", minval=0.5, maxval=3.0, step=0.1)

volume_multiplier = mode == "CONSERVATIVE" ? volume_multiplier_conservative :
                    mode == "BALANCED" ? volume_multiplier_balanced :
                    volume_multiplier_aggressive

// --- ATR PARAMETERS ---
atr_length = input.int(14, "ATR Length", minval=5, maxval=50)
atr_multiplier_conservative = input.float(0.8, "ATR Multiplier (Conservative)", minval=0.3, maxval=2.0, step=0.1)
atr_multiplier_balanced = input.float(0.6, "ATR Multiplier (Balanced)", minval=0.3, maxval=2.0, step=0.1)
atr_multiplier_aggressive = input.float(0.4, "ATR Multiplier (Aggressive)", minval=0.3, maxval=2.0, step=0.1)

atr_multiplier = mode == "CONSERVATIVE" ? atr_multiplier_conservative :
                 mode == "BALANCED" ? atr_multiplier_balanced :
                 atr_multiplier_aggressive

// --- TREND PARAMETERS ---
ema_short = input.int(20, "EMA Short Period", minval=5, maxval=100)
ema_long = input.int(50, "EMA Long Period", minval=20, maxval=200)
trend_strength_threshold = input.float(0.02, "Trend Strength Threshold", minval=0.005, maxval=0.1, step=0.005)

// --- REGIME DETECTION ---
bb_length = input.int(20, "Bollinger Bands Length", minval=5, maxval=50)
bb_mult = input.float(2.0, "Bollinger Bands StdDev", minval=1.0, maxval=3.0, step=0.1)
regime_range_threshold_conservative = input.float(0.03, "Range Threshold Conservative (%)", minval=0.01, maxval=0.1, step=0.005)
regime_range_threshold_balanced = input.float(0.02, "Range Threshold Balanced (%)", minval=0.01, maxval=0.1, step=0.005)
regime_range_threshold_aggressive = input.float(0.015, "Range Threshold Aggressive (%)", minval=0.01, maxval=0.1, step=0.005)

regime_range_threshold = mode == "CONSERVATIVE" ? regime_range_threshold_conservative :
                         mode == "BALANCED" ? regime_range_threshold_balanced :
                         regime_range_threshold_aggressive

// --- ADAPTIVE SYSTEM ---
enable_adaptive = input.bool(true, "Enable Adaptive Threshold")
consecutive_loss_threshold = input.int(5, "Consecutive Losses to Trigger Adapt", minval=2, maxval=10)
adaptive_step = input.float(0.03, "Adaptive Step Size", minval=0.01, maxval=0.1, step=0.01)
adaptive_max_increase = input.float(0.15, "Max Adaptive Increase", minval=0.05, maxval=0.3, step=0.05)

// --- SYMBOL-SPECIFIC ADJUSTMENTS ---
enable_symbol_adjustment = input.bool(true, "Enable Symbol-Specific Adjustments")
eth_penalty = input.float(0.85, "ETH Confidence Multiplier", minval=0.5, maxval=1.0, step=0.05,
     tooltip="0.85 = 15% penalty for ETH (less volatile than BTC)")
sol_penalty = input.float(0.90, "SOL Confidence Multiplier", minval=0.5, maxval=1.0, step=0.05,
     tooltip="0.90 = 10% penalty for SOL")

// --- WEBHOOK SETTINGS ---
enable_webhook = input.bool(true, "Enable Webhook Alerts")
webhook_url = input.string("http://103.189.234.15/webhook_v1", "Webhook URL")

// --- VISUAL SETTINGS ---
show_signals = input.bool(true, "Show Buy/Sell Signals")
show_confidence_label = input.bool(true, "Show Confidence Labels")
show_filters_status = input.bool(true, "Show Filter Status Table")

// ============================================================================
// TECHNICAL INDICATORS
// ============================================================================

// --- MOVING AVERAGES ---
ema_short_line = ta.ema(close, ema_short)
ema_long_line = ta.ema(close, ema_long)

// --- RSI ---
rsi = ta.rsi(close, 14)

// --- MACD ---
[macd_line, macd_signal, macd_hist] = ta.macd(close, 12, 26, 9)

// --- BOLLINGER BANDS ---
[bb_middle, bb_upper, bb_lower] = ta.bb(close, bb_length, bb_mult)
bb_width = (bb_upper - bb_lower) / bb_middle
bb_position = (close - bb_lower) / (bb_upper - bb_lower)
is_bb_squeeze = bb_width < ta.sma(bb_width, 20) * 0.7  // Squeeze detection

// --- ATR ---
atr = ta.atr(atr_length)
atr_sma = ta.sma(atr, atr_length)

// --- VOLUME ---
volume_sma = ta.sma(volume, volume_sma_length)

// --- STOCHASTIC ---
stoch_k = ta.stoch(close, high, low, 14)
stoch_d = ta.sma(stoch_k, 3)

// --- ADX (Trend Strength) ---
[diplus, diminus, adx] = ta.dmi(14, 14)

// --- ON-BALANCE VOLUME (OBV) ---
obv = ta.cum(math.sign(ta.change(close)) * volume)
obv_ema = ta.ema(obv, 20)

// ============================================================================
// SIGNAL GENERATION
// ============================================================================

// --- BULLISH SIGNALS ---
bullish_ema_cross = ta.crossover(ema_short_line, ema_long_line)
bullish_macd_cross = ta.crossover(macd_line, macd_signal) and macd_line < 0
bullish_rsi_reversal = ta.crossover(rsi, 30) and rsi < 40
bullish_bb_bounce = close < bb_lower * 1.02 and close > bb_lower * 0.98
bullish_stoch = ta.crossover(stoch_k, stoch_d) and stoch_k < 30
bullish_volume = volume > volume_sma * 1.2 and close > open
bullish_obv = ta.crossover(obv, obv_ema)

// --- BEARISH SIGNALS ---
bearish_ema_cross = ta.crossunder(ema_short_line, ema_long_line)
bearish_macd_cross = ta.crossunder(macd_line, macd_signal) and macd_line > 0
bearish_rsi_reversal = ta.crossunder(rsi, 70) and rsi > 60
bearish_bb_bounce = close > bb_upper * 0.98 and close < bb_upper * 1.02
bearish_stoch = ta.crossunder(stoch_k, stoch_d) and stoch_k > 70
bearish_volume = volume > volume_sma * 1.2 and close < open
bearish_obv = ta.crossunder(obv, obv_ema)

// ============================================================================
// CONFIDENCE CALCULATION
// ============================================================================

// --- BULLISH CONFIDENCE (0-1 scale) ---
var float bull_confidence = 0.0
bull_confidence := 0.0

// Base signals (each worth ~0.15)
if bullish_ema_cross
    bull_confidence += 0.20
if bullish_macd_cross
    bull_confidence += 0.18
if bullish_rsi_reversal
    bull_confidence += 0.15
if bullish_bb_bounce
    bull_confidence += 0.12
if bullish_stoch
    bull_confidence += 0.12
if bullish_volume
    bull_confidence += 0.10
if bullish_obv
    bull_confidence += 0.08

// Trend alignment bonus (if price above EMA20)
if close > ema_short_line
    bull_confidence += 0.10

// Momentum bonus (if ADX strong)
if adx > 25
    bull_confidence += 0.05

// --- BEARISH CONFIDENCE (0-1 scale) ---
var float bear_confidence = 0.0
bear_confidence := 0.0

// Base signals
if bearish_ema_cross
    bear_confidence += 0.20
if bearish_macd_cross
    bear_confidence += 0.18
if bearish_rsi_reversal
    bear_confidence += 0.15
if bearish_bb_bounce
    bear_confidence += 0.12
if bearish_stoch
    bear_confidence += 0.12
if bearish_volume
    bear_confidence += 0.10
if bearish_obv
    bear_confidence += 0.08

// Trend alignment bonus (if price below EMA20)
if close < ema_short_line
    bear_confidence += 0.10

// Momentum bonus
if adx > 25
    bear_confidence += 0.05

// Normalize to 0-1
bull_confidence := math.min(bull_confidence, 1.0)
bear_confidence := math.min(bear_confidence, 1.0)

// ============================================================================
// FILTERS
// ============================================================================

// --- 1. VOLUME FILTER ---
volume_confirmed = not enable_volume_filter or volume > volume_sma * volume_multiplier

// --- 2. ATR FILTER (Volatility) ---
atr_confirmed = not enable_atr_filter or atr > atr_sma * atr_multiplier

// --- 3. TREND QUALITY FILTER ---
trend_strength = math.abs(ema_short_line - ema_long_line) / close
is_strong_trend = trend_strength > trend_strength_threshold
trend_quality_ok = not enable_trend_filter or is_strong_trend or adx > 20

// --- 4. MARKET REGIME FILTER ---
range_pct = (high - low) / close
is_tradeable_regime = not is_bb_squeeze and range_pct > regime_range_threshold
regime_ok = not enable_regime_filter or is_tradeable_regime

// --- ALL FILTERS PASS ---
all_filters_pass = volume_confirmed and atr_confirmed and trend_quality_ok and regime_ok

// ============================================================================
// SYMBOL-SPECIFIC ADJUSTMENTS
// ============================================================================

// Detect symbol
is_eth_symbol = str.contains(syminfo.ticker, "ETH")
is_sol_symbol = str.contains(syminfo.ticker, "SOL")
is_btc_symbol = str.contains(syminfo.ticker, "BTC")

// Apply penalties
var float symbol_multiplier = 1.0
symbol_multiplier := 1.0

if enable_symbol_adjustment
    if is_eth_symbol
        symbol_multiplier := eth_penalty
    else if is_sol_symbol
        symbol_multiplier := sol_penalty
    // BTC gets no penalty (1.0)

bull_confidence := bull_confidence * symbol_multiplier
bear_confidence := bear_confidence * symbol_multiplier

// ============================================================================
// ADAPTIVE THRESHOLD SYSTEM
// ============================================================================

// Track consecutive losses (simplified - in production use session tracking)
var int consecutive_losses = 0
var float dynamic_min_confidence = min_confidence

// Reset logic (when we get a win, reset counter)
// In real implementation, this would be updated via webhook feedback
// For now, we'll use a simplified heuristic

// Adaptive adjustment
if enable_adaptive
    if consecutive_losses >= consecutive_loss_threshold
        // Increase threshold to be more selective
        increase = math.min(adaptive_step * (consecutive_losses - consecutive_loss_threshold + 1), adaptive_max_increase)
        dynamic_min_confidence := math.min(min_confidence + increase, 0.90)
    else
        // Reset to baseline
        dynamic_min_confidence := min_confidence
else
    dynamic_min_confidence := min_confidence

// ============================================================================
// COOLDOWN MECHANISM
// ============================================================================

var int last_signal_bar = 0
bars_since_signal = bar_index - last_signal_bar
cooldown_ok = bars_since_signal >= cooldown_bars

// ============================================================================
// FINAL SIGNAL DECISION
// ============================================================================

// BULLISH SIGNAL
ultimate_bull_signal = bull_confidence >= dynamic_min_confidence and
                       all_filters_pass and
                       cooldown_ok and
                       bear_confidence < bull_confidence  // Ensure no conflict

// BEARISH SIGNAL
ultimate_bear_signal = bear_confidence >= dynamic_min_confidence and
                       all_filters_pass and
                       cooldown_ok and
                       bull_confidence < bear_confidence  // Ensure no conflict

// Update last signal bar
if ultimate_bull_signal or ultimate_bear_signal
    last_signal_bar := bar_index

// ============================================================================
// VISUALIZATION
// ============================================================================

// --- PLOT MOVING AVERAGES ---
plot(ema_short_line, "EMA Short", color=color.new(color.blue, 30), linewidth=2)
plot(ema_long_line, "EMA Long", color=color.new(color.orange, 30), linewidth=2)

// --- PLOT BOLLINGER BANDS ---
plot(bb_upper, "BB Upper", color=color.new(color.gray, 70))
plot(bb_middle, "BB Middle", color=color.new(color.gray, 70))
plot(bb_lower, "BB Lower", color=color.new(color.gray, 70))

// --- SIGNAL SHAPES ---
plotshape(
     show_signals and ultimate_bull_signal,
     title="BUY Signal",
     location=location.belowbar,
     color=color.new(color.green, 0),
     style=shape.labelup,
     text="BUY",
     textcolor=color.white,
     size=size.normal
)

plotshape(
     show_signals and ultimate_bear_signal,
     title="SELL Signal",
     location=location.abovebar,
     color=color.new(color.red, 0),
     style=shape.labeldown,
     text="SELL",
     textcolor=color.white,
     size=size.normal
)

// --- CONFIDENCE LABELS ---
if show_confidence_label and ultimate_bull_signal
    label.new(
        bar_index,
        low,
        text="Conf: " + str.tostring(math.round(bull_confidence * 100)) + "%\nMode: " + mode,
        color=color.new(color.green, 20),
        textcolor=color.white,
        style=label.style_label_up,
        size=size.small
    )

if show_confidence_label and ultimate_bear_signal
    label.new(
        bar_index,
        high,
        text="Conf: " + str.tostring(math.round(bear_confidence * 100)) + "%\nMode: " + mode,
        color=color.new(color.red, 20),
        textcolor=color.white,
        style=label.style_label_down,
        size=size.small
    )

// --- FILTER STATUS TABLE ---
if show_filters_status
    var table status_table = table.new(position.top_right, 2, 8,
         bgcolor=color.new(color.black, 80),
         frame_color=color.gray,
         frame_width=1)

    if barstate.islast
        // Header
        table.cell(status_table, 0, 0, "Filter", text_color=color.white, bgcolor=color.new(color.blue, 50))
        table.cell(status_table, 1, 0, "Status", text_color=color.white, bgcolor=color.new(color.blue, 50))

        // Mode
        table.cell(status_table, 0, 1, "Mode", text_color=color.white)
        table.cell(status_table, 1, 1, mode,
             text_color=mode == "BALANCED" ? color.yellow : mode == "CONSERVATIVE" ? color.orange : color.lime,
             bgcolor=color.new(color.gray, 80))

        // Volume
        table.cell(status_table, 0, 2, "Volume", text_color=color.white)
        table.cell(status_table, 1, 2, volume_confirmed ? "✓" : "✗",
             text_color=volume_confirmed ? color.green : color.red,
             bgcolor=color.new(color.gray, 80))

        // ATR
        table.cell(status_table, 0, 3, "ATR", text_color=color.white)
        table.cell(status_table, 1, 3, atr_confirmed ? "✓" : "✗",
             text_color=atr_confirmed ? color.green : color.red,
             bgcolor=color.new(color.gray, 80))

        // Trend
        table.cell(status_table, 0, 4, "Trend", text_color=color.white)
        table.cell(status_table, 1, 4, trend_quality_ok ? "✓" : "✗",
             text_color=trend_quality_ok ? color.green : color.red,
             bgcolor=color.new(color.gray, 80))

        // Regime
        table.cell(status_table, 0, 5, "Regime", text_color=color.white)
        table.cell(status_table, 1, 5, regime_ok ? "✓" : "✗",
             text_color=regime_ok ? color.green : color.red,
             bgcolor=color.new(color.gray, 80))

        // Cooldown
        table.cell(status_table, 0, 6, "Cooldown", text_color=color.white)
        table.cell(status_table, 1, 6, cooldown_ok ? "Ready" : str.tostring(cooldown_bars - bars_since_signal) + " bars",
             text_color=cooldown_ok ? color.green : color.orange,
             bgcolor=color.new(color.gray, 80))

        // Confidence
        conf_display = math.max(bull_confidence, bear_confidence)
        table.cell(status_table, 0, 7, "Confidence", text_color=color.white)
        table.cell(status_table, 1, 7, str.tostring(math.round(conf_display * 100)) + "%",
             text_color=conf_display >= dynamic_min_confidence ? color.green : color.gray,
             bgcolor=color.new(color.gray, 80))

// ============================================================================
// BACKGROUND COLOR (Market Regime)
// ============================================================================
regime_color = is_bb_squeeze ? color.new(color.red, 95) :
               is_strong_trend ? color.new(color.green, 95) :
               color.new(color.yellow, 97)
bgcolor(regime_color, title="Regime Color")

// ============================================================================
// ALERTS & WEBHOOK
// ============================================================================

// --- BULLISH ALERT ---
if ultimate_bull_signal and enable_webhook
    alert_message = '{"action":"BUY","symbol":"' + syminfo.ticker +
                    '","price":' + str.tostring(close) +
                    ',"confidence":' + str.tostring(bull_confidence) +
                    ',"atr":' + str.tostring(atr) +
                    ',"mode":"' + mode +
                    '","timestamp":"' + str.tostring(timenow) +
                    '","token":"sniper-bybit-production-2024"}'

    alert(alert_message, alert.freq_once_per_bar)

// --- BEARISH ALERT ---
if ultimate_bear_signal and enable_webhook
    alert_message = '{"action":"SELL","symbol":"' + syminfo.ticker +
                    '","price":' + str.tostring(close) +
                    ',"confidence":' + str.tostring(bear_confidence) +
                    ',"atr":' + str.tostring(atr) +
                    ',"mode":"' + mode +
                    '","timestamp":"' + str.tostring(timenow) +
                    '","token":"sniper-bybit-production-2024"}'

    alert(alert_message, alert.freq_once_per_bar)

// ============================================================================
// DEBUGGING OUTPUT (Comment out for production)
// ============================================================================

// Debug plot for confidence levels
// plot(bull_confidence, "Bull Confidence", color=color.green, display=display.data_window)
// plot(bear_confidence, "Bear Confidence", color=color.red, display=display.data_window)
// plot(dynamic_min_confidence, "Dynamic Threshold", color=color.orange, display=display.data_window)

// ============================================================================
// PERFORMANCE METRICS (for backtesting)
// ============================================================================

// Track signal performance (simplified)
var int total_signals = 0
var int winning_signals = 0

if ultimate_bull_signal or ultimate_bear_signal
    total_signals += 1

// Win detection (simplified - checks if price moved in predicted direction after 5 bars)
// In production, use proper trade tracking
if bar_index >= 5
    was_bull_signal = ultimate_bull_signal[5]
    was_bear_signal = ultimate_bear_signal[5]
    entry_price = close[5]
    current_price = close

    if was_bull_signal and current_price > entry_price * 1.01
        winning_signals += 1
    if was_bear_signal and current_price < entry_price * 0.99
        winning_signals += 1

// Calculate win rate
win_rate = total_signals > 0 ? (winning_signals / total_signals) * 100 : 0.0

// ============================================================================
// END OF SCRIPT
// ============================================================================
//
// NOTES FOR DEPLOYMENT:
// 1. Set up webhook alerts in TradingView (right-click chart → Add Alert)
// 2. Use alert message: {{strategy.order.alert_message}}
// 3. Webhook URL: Your production webhook endpoint
// 4. Monitor performance for 3-5 days in paper trading
// 5. Adjust mode (CONSERVATIVE/BALANCED/AGGRESSIVE) based on results
// 6. Track actual win rate vs backtested win rate
//
// EXPECTED PERFORMANCE (BALANCED Mode):
// - Signal frequency: 5-10 per day (depending on volatility)
// - Win rate target: 60-70%
// - Avg trade duration: 2-6 hours
// - Risk/Reward: 1:1.5 to 1:2
//
// ============================================================================
