# CLAUDE.md - Self-Healing Knowledge Base for deterministic-object-usage/

## What This Directory Is

This directory contains deterministic, repeatable processes for extracting feature-specific lifecycle data from changelogs and rendering them as interactive HTML visuals. It is both a product and a template: the outputs here were generated by the process documented here, and future Claude sessions should use this file to maintain continuity.

## How Claude Should Use This File

This CLAUDE.md serves as **persistent project memory**. When you start a session in this directory:

1. **Read this file first** to understand what exists, what conventions are in place, and what the open work items are.
2. **Update this file** when you complete work, discover new patterns, or learn something that future sessions need to know. This is a self-healing knowledge base -- if you find something wrong or outdated here, fix it in the same session.
3. **Append to the learning log** at the bottom of this file with dated entries capturing what you learned during the session.

## Directory Structure and Conventions

```
deterministic-object-usage/
  CLAUDE.md                                                 # This file. Read first every session.
  000-claude-filter-changelog-feature-to-html-prompt.md     # The deterministic process template (reusable)
  NNN-<feature-slug>.html                                   # Interactive HTML timeline visual
  NNN-<feature-slug>-changelog-insights.jsonl               # Structured JSONL data backing the visual
```

### Naming Rules
- Numeric prefix (NNN) is assigned sequentially: 005, 006, 007...
- The same prefix is shared between the `.html` and `.jsonl` for a given feature
- Feature slug is kebab-case: `claude-agent-memory`, `claude-hooks`, `claude-plugins`
- The `000-` prefix is reserved for meta/process documents

### Current Inventory

| Prefix | Feature | Files | Status |
|--------|---------|-------|--------|
| 000 | Process template | `000-claude-filter-changelog-feature-to-html-prompt.md` | Complete |
| 005 | Agent Memory | `005-claude-agent-memory.html`, `005-claude-agent-memory-changelog-insights.jsonl` | Complete |

## The Deterministic Process (Summary)

Full details in `000-claude-filter-changelog-feature-to-html-prompt.md`. The 5 phases:

1. **Input Specification** -- Define FEATURE_NAME, FEATURE_KEYWORDS, CHANGELOG_URL, OUTPUT_DIR, OUTPUT_FILE_PREFIX
2. **Fetch and Filter** -- Download changelog, grep with keyword regex, manual review pass
3. **Extract to JSONL** -- Write structured records with version, objects, params, tools, interactions, significance
4. **Generate HTML** -- Build interactive timeline with era markers, filters, detail panel, object graph
5. **Validate** -- Checklist of 10 items ensuring consistency and correctness

### Five Judgment Points

These are the only non-mechanical steps in the process. Everything else follows deterministically:

1. Keyword selection (requires feature domain knowledge)
2. False positive filtering (requires reading context around grep matches)
3. Era boundary placement (requires understanding the feature's narrative arc)
4. Significance classification (requires judgment about impact)
5. Interaction flow notation (requires understanding system architecture)

## Insights from Building This

These insights were discovered during the first execution (005-claude-agent-memory) and should inform future runs:

### On Changelog Parsing
- Claude Code's CHANGELOG.md uses `## X.Y.Z` headers with no dates. Approximate dates must be inferred from version ordering and known release timelines.
- Some versions have multiple entries relevant to the same feature. Use a suffix (`2.1.33`, `2.1.33b`, `2.1.33c`) as the sortable semver key to preserve ordering.
- The changelog sometimes skips version numbers (e.g., jumps from 2.1.30 to 2.1.32). This is normal and doesn't indicate missing data.
- Keyword searches produce false positives. "memory" matches "memory leak" and "memory usage" (performance) which are different from the "agent memory" feature. Context review is essential.

### On Feature Lifecycle Patterns
- Features in Claude Code follow a consistent arc: manual -> composable -> configurable -> automatic. Agent memory went from `#` shortcut (manual) to `@import` (composable) to `.claude/rules/` (configurable) to automatic recording (autonomous).
- Deprecations often signal a shift in interaction model, not removal of capability. The `#` shortcut was removed because agent-mediated CLAUDE.md editing was strictly better.
- Infrastructure changes (settings migration, directory structure) often precede major feature launches by several versions. Tracking them provides early signal.

### On HTML Visual Design
- Single-file HTML with embedded CSS/JS is the right format. No build step, no dependencies, opens in any browser.
- The object graph SVG uses category-based clustering (core, tool, param, scope, ui) which produces readable layouts without a force-directed physics simulation.
- The era marker system is critical for readability. Without eras, the timeline is a flat list. With eras, the narrative arc becomes visible.

### On JSONL as Intermediate Format
- JSONL is the correct intermediate format. Each line is independently parseable, making it easy to append, filter, or pipe through `jq`.
- Writing JSONL before HTML forces structured thinking. The HTML data should be a direct transformation of the JSONL, not independently authored.
- The JSONL serves as a reusable data source. Future work could read it programmatically to generate different visualizations, comparisons across features, or feed into tracing systems.

## Open Work / Future PRs

### PR: MLflow 3.9 Claude Tracing Integration

**Goal**: Add SDK and/or CLI MLflow 3.9 Claude Tracing to self-learn from deterministic process executions. Each PR should post an analysis of MLflow traces.

**Context**: Claude Code tracing can be configured using either CLI commands (interactive) or Python SDK imports (programmatic).

**CLI Tracing**: For interactive sessions where Claude Code is run directly in the terminal. Traces capture tool calls, model interactions, and session flow.

**SDK Tracing Setup**:
```python
import mlflow.anthropic
from claude_agent_sdk import ClaudeSDKClient

# Enable automatic tracing for Claude Agent SDK
mlflow.anthropic.autolog()

# Optionally configure MLflow experiment
mlflow.set_experiment("deterministic-object-usage")
```

Requirements:
- MLflow >= 3.5 (`pip install 'mlflow[genai]>=3.5'`)
- Claude Agent SDK >= 0.1.0 (`pip install claude-agent-sdk>=0.1.0`)
- Only `ClaudeSDKClient` supports tracing. Directly calling `query` will not be traced.

**Complete Example**:
```python
import asyncio
import mlflow.anthropic
from claude_agent_sdk import ClaudeSDKClient

mlflow.anthropic.autolog()
mlflow.set_experiment("deterministic-object-usage")

async def run_feature_extraction(feature_name, keywords, changelog_url):
    async with ClaudeSDKClient() as client:
        result = await client.query(
            f"Follow the process in 000-claude-filter-changelog-feature-to-html-prompt.md "
            f"to extract the '{feature_name}' feature using keywords {keywords} "
            f"from {changelog_url}"
        )
        return result

asyncio.run(run_feature_extraction(
    "Hooks",
    ["hook", "hooks", "PreToolUse", "PostToolUse", "SessionStart"],
    "https://raw.githubusercontent.com/anthropics/claude-code/refs/heads/main/CHANGELOG.md"
))
```

**What to trace**:
- Each Phase (1-5) as a separate span
- Keyword grep results (count of matches, false positive rate)
- JSONL extraction (number of entries, distribution of significance levels)
- HTML generation (era count, object graph node/edge counts)
- Validation checklist pass/fail status

**PR Requirements**:
- Each PR that adds or updates a feature visual MUST include an MLflow trace analysis section in the PR description
- The analysis should cover: total tool calls, model token usage, extraction accuracy (manual spot-check), and time per phase
- Traces should be stored in an experiment named `deterministic-object-usage` to allow cross-feature comparison
- Future goal: use trace data to identify which phases take the most tokens and optimize the prompts accordingly

**Implementation Steps** (for the future PR):
1. Add a `tracing/` subdirectory with a Python wrapper that invokes the process via ClaudeSDKClient
2. Add a `requirements.txt` with `mlflow[genai]>=3.5` and `claude-agent-sdk>=0.1.0`
3. Create a GitHub Action or hook that runs the trace analysis and posts results as a PR comment
4. Add a `tracing/analyze_traces.py` script that reads MLflow traces and generates a summary markdown table

### Other Future Features to Visualize

Candidates for the next NNN-prefixed feature extractions (in priority order):

| Prefix | Feature | Keywords |
|--------|---------|----------|
| 006 | Hooks | hook, hooks, PreToolUse, PostToolUse, SessionStart, SessionEnd, PermissionRequest |
| 007 | Plugins | plugin, plugins, marketplace, /plugin |
| 008 | MCP Servers | MCP, mcp, SSE, streamable HTTP, OAuth, mcp.json |
| 009 | Plan Mode | plan mode, /plan, plan file, ExitPlanMode |
| 010 | Subagents/Task Tool | subagent, Task tool, sub-agent, background agent |

## Self-Healing Rules

When working in this directory, Claude should:

1. **Check inventory** against actual files on disk. If a file listed above is missing, note it. If an unlisted file exists, add it to the inventory table.
2. **Validate JSONL integrity** before modifying: `cat *.jsonl | python3 -c "import sys,json; [json.loads(l) for l in sys.stdin]"` should succeed.
3. **Re-read the process doc** (000-...) before starting a new feature extraction, in case it was updated.
4. **Update this CLAUDE.md** at the end of every session with:
   - Any new files created (update inventory table)
   - Any insights learned (append to learning log)
   - Any corrections to existing content
5. **Never delete learning log entries**. They form a chronological record of how this knowledge base evolved.

## Learning Log

### 2026-02-13 - Initial Creation
- Created the deterministic process template (000) based on extracting agent memory feature from Claude Code CHANGELOG.md
- Generated first feature visual (005-claude-agent-memory) covering 27 changelog entries across versions 0.2.54 to 2.1.33
- Discovered the manual -> composable -> configurable -> automatic lifecycle pattern
- Identified 5 judgment points in the otherwise mechanical process
- Established JSONL-first workflow: always write structured data before generating HTML
- Noted that MLflow tracing via Claude Agent SDK (ClaudeSDKClient + mlflow.anthropic.autolog()) is the path for self-learning; direct query() calls are not traced
