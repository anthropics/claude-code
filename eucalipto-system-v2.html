<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eucalipto - Sistema Completo v2</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3e 100%); color: #eee; min-height: 100vh; }
        .header { background: linear-gradient(90deg, #0f3460, #16213e); padding: 20px; text-align: center; border-bottom: 3px solid #4ecca3; }
        .header h1 { color: #4ecca3; font-size: 24px; }
        .header p { color: #888; font-size: 12px; }
        .badges { margin-top: 10px; }
        .badge { display: inline-block; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 11px; margin: 0 5px; }
        .badge.ia { background: linear-gradient(90deg, #4ecca3, #00ff88); color: #0a0a1a; }
        .badge.google { background: linear-gradient(90deg, #ea4335, #fbbc04); color: #fff; }
        .badge.v2 { background: linear-gradient(90deg, #667eea, #764ba2); color: #fff; }
        .container { max-width: 2000px; margin: 0 auto; padding: 20px; }
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; flex-wrap: wrap; background: #16213e; padding: 10px; border-radius: 10px; overflow-x: auto; }
        .tab { padding: 12px 18px; background: transparent; border: 2px solid transparent; color: #888; cursor: pointer; border-radius: 8px; font-size: 12px; font-weight: bold; transition: all 0.3s; white-space: nowrap; }
        .tab.active { background: #4ecca3; color: #0a0a1a; }
        .tab:hover { border-color: #4ecca3; }
        .panel { display: none; }
        .panel.active { display: block; }
        .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .card { background: linear-gradient(135deg, #16213e, #0f3460); border-radius: 12px; padding: 20px; border: 1px solid #4ecca322; }
        .card h3 { color: #4ecca3; font-size: 13px; margin-bottom: 12px; }
        .card-value { font-size: 28px; font-weight: bold; color: #fff; }
        .card-label { color: #888; font-size: 11px; margin-top: 5px; }
        .table-container { background: #16213e; border-radius: 12px; overflow: hidden; margin-bottom: 20px; }
        .table-header { background: #0f3460; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .table-title { color: #4ecca3; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th { background: #0a0a1a; color: #4ecca3; padding: 12px 8px; text-align: center; font-size: 11px; }
        td { padding: 10px 8px; text-align: center; border-bottom: 1px solid #0f3460; }
        tr:hover { background: rgba(78,204,163,0.05); }
        input[type="number"], input[type="text"], input[type="date"], input[type="file"], select { background: #0a0a1a; border: 2px solid #4ecca3; color: #fff; padding: 8px 10px; border-radius: 6px; width: 90px; text-align: right; font-size: 13px; font-weight: bold; }
        input:focus { outline: none; border-color: #00ff88; box-shadow: 0 0 15px #4ecca344; }
        input.nome { text-align: left; width: 100px; }
        input.venda { border-color: #00ff88; background: #0a1a0a; }
        .btn { background: linear-gradient(90deg, #4ecca3, #00ff88); color: #0a0a1a; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 13px; transition: all 0.3s; }
        .btn:hover { transform: scale(1.05); }
        .btn.secondary { background: linear-gradient(90deg, #ffcc00, #ff9900); }
        .btn.danger { background: linear-gradient(90deg, #ff6b6b, #ff4444); }
        .btn.google { background: linear-gradient(90deg, #ea4335, #fbbc04); color: #000; }
        .btn.small { padding: 6px 12px; font-size: 11px; }
        .btn-icon { width: 30px; height: 30px; border-radius: 50%; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .status { padding: 4px 10px; border-radius: 15px; font-size: 10px; font-weight: bold; }
        .status.lucro { background: rgba(78,204,163,0.2); color: #4ecca3; }
        .status.prejuizo { background: rgba(255,107,107,0.2); color: #ff6b6b; }
        .status.atencao { background: rgba(255,204,0,0.2); color: #ffcc00; }
        .status.ativo { background: rgba(78,204,163,0.2); color: #4ecca3; }
        .status.inativo { background: rgba(100,100,100,0.2); color: #888; }
        .green { color: #4ecca3; }
        .red { color: #ff6b6b; }
        .yellow { color: #ffcc00; }
        .blue { color: #667eea; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-overlay.active { display: flex; }
        .modal { background: #16213e; border-radius: 15px; padding: 30px; width: 90%; max-width: 600px; border: 2px solid #4ecca3; max-height: 90vh; overflow-y: auto; }
        .modal h2 { color: #4ecca3; margin-bottom: 20px; }
        .modal-row { margin-bottom: 15px; }
        .modal-row label { display: block; color: #888; font-size: 12px; margin-bottom: 5px; }
        .modal-row input, .modal-row select, .modal-row textarea { width: 100%; }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .alert.success { background: rgba(78,204,163,0.2); border-left: 4px solid #4ecca3; color: #4ecca3; }
        .alert.error { background: rgba(255,107,107,0.2); border-left: 4px solid #ff6b6b; color: #ff6b6b; }
        .alert.warning { background: rgba(255,204,0,0.2); border-left: 4px solid #ffcc00; color: #ffcc00; }
        .alert.info { background: rgba(102,126,234,0.2); border-left: 4px solid #667eea; color: #667eea; }
        .chart-container { position: relative; height: 400px; margin-bottom: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .stat-box { background: #0f3460; padding: 15px; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 24px; font-weight: bold; color: #4ecca3; }
        .stat-label { color: #888; font-size: 11px; margin-top: 5px; }
        .filter-bar { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .filter-item { flex: 1; min-width: 150px; }
        .export-btn { display: inline-block; margin-right: 10px; }
        textarea { background: #0a0a1a; border: 2px solid #4ecca3; color: #fff; padding: 8px; border-radius: 6px; font-family: monospace; font-size: 12px; }
        .json-preview { background: #0a0a1a; padding: 15px; border-radius: 8px; border: 1px solid #4ecca355; max-height: 300px; overflow-y: auto; font-size: 11px; font-family: monospace; color: #4ecca3; margin-bottom: 15px; }
        .sync-status { display: inline-block; padding: 5px 10px; border-radius: 20px; font-size: 11px; margin-left: 10px; }
        .sync-status.ok { background: rgba(78,204,163,0.2); color: #4ecca3; }
        .sync-status.erro { background: rgba(255,107,107,0.2); color: #ff6b6b; }
        .sync-status.pendente { background: rgba(255,204,0,0.2); color: #ffcc00; }
        @media print { .tabs, .btn, .modal, .filter-bar { display: none; } .panel { display: block !important; } }
    </style>
</head>
<body>
    <div class="header">
        <h1>üå≤ EUCALIPTO TRATADO - SISTEMA COMPLETO V2.0</h1>
        <p>Gest√£o Total de Produtos, Pre√ßos, Vendas, Or√ßamentos com Google Sheets</p>
        <div class="badges">
            <span class="badge ia">ü§ñ IA ATIVA</span>
            <span class="badge google">üìë GOOGLE SHEETS</span>
            <span class="badge v2">‚≠ê V2.0</span>
        </div>
    </div>

    <div class="container">
        <div id="alertContainer"></div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">üìä DASHBOARD</button>
            <button class="tab" onclick="showTab('produtos')">üì¶ PRODUTOS</button>
            <button class="tab" onclick="showTab('precos')">üí∞ PRE√áOS</button>
            <button class="tab" onclick="showTab('vendas')">üìà VENDAS</button>
            <button class="tab" onclick="showTab('orcamentos')">üìã OR√áAMENTOS</button>
            <button class="tab" onclick="showTab('relatorios')">üìä RELAT√ìRIOS</button>
            <button class="tab" onclick="showTab('google-sheets')">üìë GOOGLE SHEETS</button>
            <button class="tab" onclick="showTab('historico')">üïê HIST√ìRICO</button>
            <button class="tab" onclick="showTab('importar-exportar')">üíæ IMPORTAR/EXPORTAR</button>
            <button class="tab" onclick="showTab('config')">‚öôÔ∏è CONFIG</button>
        </div>

        <!-- DASHBOARD -->
        <div id="dashboard" class="panel active">
            <div class="grid-4">
                <div class="card"><h3>üìà MARGEM M√âDIA</h3><div class="card-value" id="kpiMargem">0%</div><div class="card-label">Rentabilidade</div></div>
                <div class="card"><h3>üí∞ FATURAMENTO</h3><div class="card-value green" id="kpiFaturamento">R$ 0</div><div class="card-label">Total vendido</div></div>
                <div class="card"><h3>üíµ LUCRO L√çQUIDO</h3><div class="card-value" id="kpiLucroLiq">R$ 0</div><div class="card-label">Lucro real</div></div>
                <div class="card"><h3>üì¶ PRODUTOS</h3><div class="card-value" id="kpiProdutos">0</div><div class="card-label">Bitolas ativas</div></div>
            </div>

            <div class="grid-4">
                <div class="card"><h3>üõí VENDAS</h3><div class="card-value blue" id="kpiVendas">0</div><div class="card-label">Transa√ß√µes</div></div>
                <div class="card"><h3>üìã OR√áAMENTOS</h3><div class="card-value" id="kpiOrcamentos">0</div><div class="card-label">Pendentes</div></div>
                <div class="card"><h3>‚ö†Ô∏è ALERTAS</h3><div class="card-value red" id="kpiAlertas">0</div><div class="card-label">Produtos cr√≠ticos</div></div>
                <div class="card"><h3>‚úÖ √öLTIMAS 24H</h3><div class="card-value" id="kpiUltimas24h">R$ 0</div><div class="card-label">Faturamento</div></div>
            </div>

            <div class="chart-container">
                <canvas id="chartFaturamento"></canvas>
            </div>

            <div class="grid-2">
                <div class="card"><h3>üèÜ TOP 5 PRODUTOS VENDIDOS</h3><div id="topVendidos"></div></div>
                <div class="card"><h3>üí∞ TOP 5 MAIS LUCRATIVOS</h3><div id="topLucrativos"></div></div>
            </div>
        </div>

        <!-- PRODUTOS -->
        <div id="produtos" class="panel">
            <div class="table-container">
                <div class="table-header">
                    <span class="table-title">üì¶ GEST√ÉO DE PRODUTOS</span>
                    <button class="btn" onclick="abrirModalProduto()">‚ûï ADICIONAR</button>
                </div>
                <table>
                    <thead><tr><th></th><th>BITOLA</th><th>√ò</th><th>COMP</th><th>VOL</th><th>P√á/ST</th><th>CUSTO</th><th>DESCRI√á√ÉO</th><th>STATUS</th></tr></thead>
                    <tbody id="tabelaProdutos"></tbody>
                </table>
            </div>
        </div>

        <!-- PRE√áOS -->
        <div id="precos" class="panel">
            <div class="table-container">
                <div class="table-header">
                    <span class="table-title">üí∞ PRE√áOS E MARGENS</span>
                    <div><button class="btn small" onclick="aplicarSugeridos()">‚ú® SUGERIDOS</button><button class="btn small secondary" onclick="resetar()">üîÑ RESETAR</button></div>
                </div>
                <table>
                    <thead><tr><th>PRODUTO</th><th>CUSTO</th><th>PRE√áO M√çN</th><th>PRE√áO M√ÅX</th><th>MARGEM %</th><th>SUGERIDO</th><th>STATUS</th></tr></thead>
                    <tbody id="tabelaPrecos"></tbody>
                </table>
            </div>
        </div>

        <!-- VENDAS -->
        <div id="vendas" class="panel">
            <div style="margin-bottom: 20px;">
                <button class="btn" onclick="abrirModalVenda()">‚ûï NOVA VENDA</button>
            </div>
            
            <div class="filter-bar">
                <div class="filter-item">
                    <label style="color:#888;font-size:11px">Filtrar por Cliente</label>
                    <input type="text" id="filtroCliente" placeholder="Nome do cliente" onkeyup="filtrarVendas()" style="width:100%;margin-top:5px">
                </div>
                <div class="filter-item">
                    <label style="color:#888;font-size:11px">Per√≠odo</label>
                    <input type="date" id="filtroPeriodo" onchange="filtrarVendas()" style="width:100%;margin-top:5px">
                </div>
            </div>

            <div class="table-container">
                <div class="table-header">
                    <span class="table-title">üìà HIST√ìRICO DE VENDAS</span>
                </div>
                <table>
                    <thead><tr><th>DATA</th><th>CLIENTE</th><th>PRODUTO</th><th>QTDADE</th><th>UN.</th><th>PRE√áO</th><th>TOTAL</th><th>A√á√ïES</th></tr></thead>
                    <tbody id="tabelaVendas"></tbody>
                </table>
            </div>
        </div>

        <!-- OR√áAMENTOS -->
        <div id="orcamentos" class="panel">
            <div style="margin-bottom: 20px;">
                <button class="btn" onclick="abrirModalOrcamento()">‚ûï NOVO OR√áAMENTO</button>
            </div>
            <div id="listaOrcamentos"></div>
        </div>

        <!-- RELAT√ìRIOS -->
        <div id="relatorios" class="panel">
            <div class="grid-2" style="margin-bottom: 20px;">
                <div class="card"><h3>üìä RESUMO FINANCEIRO</h3>
                    <div id="resumoFinanceiro"></div>
                </div>
                <div class="card"><h3>üéØ METAS VS REALIZADO</h3>
                    <div id="metasRealizado"></div>
                </div>
            </div>

            <div class="chart-container">
                <h3 style="color:#4ecca3;margin-bottom:15px">Faturamento por Produto</h3>
                <canvas id="chartProdutos"></canvas>
            </div>

            <div class="chart-container">
                <h3 style="color:#4ecca3;margin-bottom:15px">Margem por Produto</h3>
                <canvas id="chartMargem"></canvas>
            </div>
        </div>

        <!-- GOOGLE SHEETS -->
        <div id="google-sheets" class="panel">
            <div class="grid-2">
                <div class="card">
                    <h3>üìë STATUS GOOGLE SHEETS</h3>
                    <div id="statusGoogleSheets" style="padding:15px;background:#0f3460;border-radius:8px;margin-top:10px;">
                        <div style="margin-bottom:10px"><strong>Status:</strong> <span id="gsStatus" class="sync-status pendente">Carregando...</span></div>
                        <div style="margin-bottom:10px"><strong>Spreadsheet ID:</strong> <code style="color:#4ecca3">***</code></div>
                        <div><strong>API Key:</strong> <code style="color:#4ecca3">***</code></div>
                    </div>
                    <button class="btn google" style="margin-top:15px;width:100%" onclick="verificarStatusGoogleSheets()">üîÑ VERIFICAR STATUS</button>
                </div>

                <div class="card">
                    <h3>üîÑ SINCRONIZA√á√ÉO</h3>
                    <p style="color:#888;font-size:12px;margin-bottom:10px">Escolha a dire√ß√£o da sincroniza√ß√£o:</p>
                    <button class="btn secondary" style="width:100%;margin-bottom:10px" onclick="sincronizarDe()">üì• CARREGAR DE SHEETS</button>
                    <button class="btn secondary" style="width:100%" onclick="sincronizarPara()">üì§ EXPORTAR PARA SHEETS</button>
                    <div id="syncLog" style="margin-top:15px;padding:10px;background:#0f3460;border-radius:8px;max-height:200px;overflow-y:auto;font-size:11px;color:#888"></div>
                </div>
            </div>

            <div class="card" style="margin-top:20px">
                <h3>üìù CONFIGURA√á√ÉO GOOGLE SHEETS</h3>
                <div class="modal-row"><label>Spreadsheet ID</label><input type="text" id="configSheetsId" placeholder="Copie da URL" style="width:100%"></div>
                <div class="modal-row"><label>API Key</label><input type="password" id="configSheetsKey" placeholder="Sua chave de API" style="width:100%"></div>
                <button class="btn" style="width:100%;margin-top:15px" onclick="salvarConfigGoogle()">üíæ SALVAR CONFIGURA√á√ÉO</button>
            </div>
        </div>

        <!-- HIST√ìRICO -->
        <div id="historico" class="panel">
            <div style="margin-bottom:20px">
                <button class="btn danger" onclick="limparHistorico()">üóëÔ∏è LIMPAR HIST√ìRICO</button>
                <button class="btn secondary" onclick="exportarHistorico()">üì• EXPORTAR</button>
            </div>
            <div id="listaHistorico"></div>
        </div>

        <!-- IMPORTAR/EXPORTAR -->
        <div id="importar-exportar" class="panel">
            <div class="grid-2">
                <div class="card">
                    <h3>üì• IMPORTAR DADOS</h3>
                    <div class="modal-row"><label>CSV (Produtos)</label><input type="file" id="importProdutos" accept=".csv" style="width:100%"></div>
                    <button class="btn secondary" style="width:100%;margin-top:10px" onclick="importarProdutosCSV()">IMPORTAR PRODUTOS</button>
                    
                    <div class="modal-row" style="margin-top:20px"><label>JSON (Backup Completo)</label><input type="file" id="importJSON" accept=".json" style="width:100%"></div>
                    <button class="btn secondary" style="width:100%;margin-top:10px" onclick="importarJSON()">IMPORTAR BACKUP</button>
                </div>

                <div class="card">
                    <h3>üì§ EXPORTAR DADOS</h3>
                    <button class="btn" style="width:100%;margin-bottom:10px" onclick="exportarProdutosCSV()">üì• EXPORTAR PRODUTOS (CSV)</button>
                    <button class="btn" style="width:100%;margin-bottom:10px" onclick="exportarVendasCSV()">üì• EXPORTAR VENDAS (CSV)</button>
                    <button class="btn" style="width:100%;margin-bottom:10px" onclick="exportarOrcamentosCSV()">üì• EXPORTAR OR√áAMENTOS (CSV)</button>
                    <button class="btn secondary" style="width:100%;margin-bottom:10px" onclick="exportarBackup()">üíæ BACKUP COMPLETO (JSON)</button>
                    <button class="btn secondary" style="width:100%" onclick="exportarRelatorio()">üìä RELAT√ìRIO EXECUTIVO (PDF)</button>
                </div>
            </div>

            <div class="card" style="margin-top:20px">
                <h3>üìã PR√âVIA DE DADOS</h3>
                <div style="margin-bottom:15px">
                    <button class="btn small" onclick="atualizarPrevia('produtos')">Produtos</button>
                    <button class="btn small" onclick="atualizarPrevia('vendas')">Vendas</button>
                    <button class="btn small" onclick="atualizarPrevia('orcamentos')">Or√ßamentos</button>
                    <button class="btn small" onclick="atualizarPrevia('config')">Configura√ß√£o</button>
                </div>
                <div id="previewDados" class="json-preview"></div>
            </div>
        </div>

        <!-- CONFIG -->
        <div id="config" class="panel">
            <div class="grid-3">
                <div class="card"><h3>üå≤ CUSTOS</h3>
                    <div style="margin:15px 0"><label style="color:#888;font-size:12px">Madeira (R$/st):</label><br><input type="number" id="cfgMadeira" value="135" onchange="recalcular()" style="width:100%;margin-top:5px"></div>
                    <div style="margin:15px 0"><label style="color:#888;font-size:12px">Tratamento (R$/m¬≥):</label><br><input type="number" id="cfgTratamento" value="350" onchange="recalcular()" style="width:100%;margin-top:5px"></div>
                </div>

                <div class="card"><h3>üìê CONVERS√ïES</h3>
                    <div style="margin:15px 0"><label style="color:#888;font-size:12px">Coef. st‚Üím¬≥:</label><br><input type="number" id="cfgCoef" value="0.65" step="0.01" onchange="recalcular()" style="width:100%;margin-top:5px"></div>
                    <div style="margin:15px 0"><label style="color:#888;font-size:12px">Comprimento padr√£o:</label><br><input type="number" id="cfgComp" value="2.20" step="0.1" onchange="recalcular()" style="width:100%;margin-top:5px"></div>
                </div>

                <div class="card"><h3>üéØ METAS</h3>
                    <div style="margin:15px 0"><label style="color:#888;font-size:12px">Margem desejada (%):</label><br><input type="number" id="cfgMargem" value="30" onchange="recalcular()" style="width:100%;margin-top:5px"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAIS -->
    <div class="modal-overlay" id="modalProduto">
        <div class="modal">
            <h2>‚ûï Novo Produto</h2>
            <div class="modal-row"><label>Bitola</label><input type="text" id="novoNome" placeholder="Ex: 22 a 25"></div>
            <div class="modal-row"><label>Di√¢metro (cm)</label><input type="number" id="novoDiam" value="23" step="0.5" style="width:100%"></div>
            <div class="modal-row"><label>Comprimento (m)</label><input type="number" id="novoComp" value="2.20" step="0.1" style="width:100%"></div>
            <div class="modal-row"><label>Pre√ßo M√≠n (R$)</label><input type="number" id="novoMin" value="70" step="0.5" style="width:100%"></div>
            <div class="modal-row"><label>Pre√ßo M√°x (R$)</label><input type="number" id="novoMax" value="85" step="0.5" style="width:100%"></div>
            <div class="modal-row"><label>Descri√ß√£o</label><textarea id="novoDesc" placeholder="Descri√ß√£o do produto" style="width:100%;height:80px"></textarea></div>
            <div class="modal-row"><label>Aplica√ß√£o</label><input type="text" id="novoAplic" placeholder="Uso principal"></div>
            <div class="modal-row"><label>Classe</label><input type="text" id="novoClasse" placeholder="Ex: C20, C30"></div>
            <div class="modal-actions"><button class="btn" onclick="adicionarProduto()">‚úÖ Adicionar</button><button class="btn danger" onclick="fecharModalProduto()">‚ùå Cancelar</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="modalVenda">
        <div class="modal">
            <h2>üìà Nova Venda</h2>
            <div class="modal-row"><label>Data</label><input type="date" id="vendaData" style="width:100%"></div>
            <div class="modal-row"><label>Cliente</label><input type="text" id="vendaCliente" placeholder="Nome do cliente" style="width:100%"></div>
            <div class="modal-row"><label>Produto</label><select id="vendaProduto" style="width:100%"><option value="">-- Selecionar --</option></select></div>
            <div class="modal-row"><label>Quantidade</label><input type="number" id="vendaQtd" value="1" min="0.01" step="0.01" style="width:100%"></div>
            <div class="modal-row"><label>Unidade</label><select id="vendaUnid" style="width:100%"><option value="peca">Pe√ßas</option><option value="st">Est√©reos</option><option value="m3">M¬≥</option></select></div>
            <div class="modal-row"><label>Pre√ßo Unit√°rio (R$)</label><input type="number" id="vendaPreco" value="0" step="0.01" style="width:100%"></div>
            <div class="modal-actions"><button class="btn" onclick="adicionarVenda()">‚úÖ Registrar</button><button class="btn danger" onclick="fecharModalVenda()">‚ùå Cancelar</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="modalOrcamento">
        <div class="modal">
            <h2>üìã Novo Or√ßamento</h2>
            <div class="modal-row"><label>Data</label><input type="date" id="orcData" style="width:100%"></div>
            <div class="modal-row"><label>Cliente</label><input type="text" id="orcCliente" placeholder="Nome do cliente" style="width:100%"></div>
            <div id="itensOrcamento"></div>
            <button class="btn small secondary" onclick="adicionarItemOrcamento()" style="margin-bottom:15px">‚ûï Adicionar Item</button>
            <div class="modal-actions"><button class="btn" onclick="salvarOrcamento()">‚úÖ Salvar</button><button class="btn danger" onclick="fecharModalOrcamento()">‚ùå Cancelar</button></div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api';
        let produtos = [];
        let vendas = [];
        let orcamentos = [];
        let historico = [];
        let nextProdutoId = 1;

        // ===== INICIALIZA√á√ÉO =====
        async function init() {
            document.getElementById('vendaData').valueAsDate = new Date();
            document.getElementById('orcData').valueAsDate = new Date();
            carregarDados();
            recalcular();
        }

        // ===== GERENCIAMENTO DE DADOS =====
        function getConfig() {
            return {
                madeira: parseFloat(document.getElementById('cfgMadeira').value) || 135,
                tratamento: parseFloat(document.getElementById('cfgTratamento').value) || 350,
                coef: parseFloat(document.getElementById('cfgCoef').value) || 0.65,
                comp: parseFloat(document.getElementById('cfgComp').value) || 2.20,
                margemDesejada: parseFloat(document.getElementById('cfgMargem').value) || 30
            };
        }

        function fmt(v) {
            return 'R$ ' + (v || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function calcVolume(d, c) {
            return Math.PI * Math.pow((d / 100) / 2, 2) * c;
        }

        function calcDados(p, cfg) {
            const comp = p.comprimento || cfg.comp;
            const vol = calcVolume(p.diametro, comp);
            const pecasM3 = Math.round(1 / vol);
            const pecasSt = Math.round(pecasM3 * cfg.coef);
            const custoPorPecaMadeira = cfg.madeira / pecasSt;
            const custoPorPecaTratamento = vol * cfg.tratamento;
            const custoTotal = custoPorPecaMadeira + custoPorPecaTratamento;
            const sugerido = custoTotal * (1 + cfg.margemDesejada / 100);
            const margemMin = ((p.precoMin - custoTotal) / custoTotal) * 100;
            const margemMax = ((p.precoMax - custoTotal) / custoTotal) * 100;

            return { vol, pecasM3, pecasSt, custoTotal, sugerido, margemMin, margemMax };
        }

        function carregarDados() {
            const saved = localStorage.getItem('eucaliptoData');
            if (saved) {
                const data = JSON.parse(saved);
                produtos = data.produtos || [];
                vendas = data.vendas || [];
                orcamentos = data.orcamentos || [];
                historico = data.historico || [];
                nextProdutoId = Math.max(...produtos.map(p => p.id || 0), 0) + 1;
            }
        }

        function salvarDados() {
            localStorage.setItem('eucaliptoData', JSON.stringify({ produtos, vendas, orcamentos, historico }));
        }

        // ===== PRODUTOS =====
        function abrirModalProduto() {
            document.getElementById('novoNome').value = '';
            document.getElementById('novoDiam').value = '23';
            document.getElementById('novoComp').value = '2.20';
            document.getElementById('novoMin').value = '70';
            document.getElementById('novoMax').value = '85';
            document.getElementById('novoDesc').value = '';
            document.getElementById('novoAplic').value = '';
            document.getElementById('novoClasse').value = '';
            document.getElementById('modalProduto').classList.add('active');
        }

        function fecharModalProduto() {
            document.getElementById('modalProduto').classList.remove('active');
        }

        function adicionarProduto() {
            const nome = document.getElementById('novoNome').value?.trim();
            const diam = parseFloat(document.getElementById('novoDiam').value);
            const comp = parseFloat(document.getElementById('novoComp').value);
            const min = parseFloat(document.getElementById('novoMin').value);
            const max = parseFloat(document.getElementById('novoMax').value);
            const desc = document.getElementById('novoDesc').value;
            const aplic = document.getElementById('novoAplic').value;
            const classe = document.getElementById('novoClasse').value;

            if (!nome || !diam || !comp || !min || !max || min >= max) {
                mostraAlerta('Verifique os dados inseridos', 'error');
                return;
            }

            produtos.push({ id: nextProdutoId++, nome, diametro: diam, comprimento: comp, precoMin: min, precoMax: max, descricao: desc, aplicacao: aplic, classe });
            salvarDados();
            mostraAlerta(`Produto "${nome}" adicionado!`, 'success');
            fecharModalProduto();
            recalcular();
        }

        // ===== VENDAS =====
        function abrirModalVenda() {
            document.getElementById('vendaData').valueAsDate = new Date();
            document.getElementById('vendaCliente').value = '';
            document.getElementById('vendaProduto').innerHTML = '<option value="">-- Selecionar --</option>' + produtos.map(p => `<option value="${p.id}">${p.nome}</option>`).join('');
            document.getElementById('vendaQtd').value = '1';
            document.getElementById('vendaPreco').value = '0';
            document.getElementById('modalVenda').classList.add('active');
        }

        function fecharModalVenda() {
            document.getElementById('modalVenda').classList.remove('active');
        }

        function adicionarVenda() {
            const data = document.getElementById('vendaData').value;
            const cliente = document.getElementById('vendaCliente').value?.trim();
            const prodId = parseInt(document.getElementById('vendaProduto').value);
            const qtd = parseFloat(document.getElementById('vendaQtd').value);
            const unid = document.getElementById('vendaUnid').value;
            const preco = parseFloat(document.getElementById('vendaPreco').value);

            if (!data || !cliente || !prodId || !qtd || !preco) {
                mostraAlerta('Preencha todos os campos', 'error');
                return;
            }

            const prod = produtos.find(p => p.id === prodId);
            vendas.push({ id: 'VND-' + Date.now(), data, cliente, produtoId: prodId, quantidade: qtd, unidade: unid, precoUnitario: preco, total: qtd * preco, dataCriacao: new Date().toISOString() });
            salvarDados();
            mostraAlerta('Venda registrada!', 'success');
            fecharModalVenda();
            recalcular();
        }

        function filtrarVendas() {
            const cliente = document.getElementById('filtroCliente').value.toLowerCase();
            const periodo = document.getElementById('filtroPeriodo').value;

            const vendas_filtradas = vendas.filter(v => {
                return v.cliente.toLowerCase().includes(cliente) && (!periodo || v.data.includes(periodo));
            });

            renderVendas(vendas_filtradas);
        }

        function renderVendas(vendas_array) {
            document.getElementById('tabelaVendas').innerHTML = (vendas_array || vendas).map(v => {
                const prod = produtos.find(p => p.id === v.produtoId);
                return `<tr>
                    <td>${v.data}</td>
                    <td>${v.cliente}</td>
                    <td>${prod?.nome || '?'}</td>
                    <td>${v.quantidade}</td>
                    <td>${v.unidade}</td>
                    <td>${fmt(v.precoUnitario)}</td>
                    <td class="green"><strong>${fmt(v.total)}</strong></td>
                    <td><button class="btn-icon danger" onclick="removerVenda('${v.id}')">üóëÔ∏è</button></td>
                </tr>`;
            }).join('');
        }

        function removerVenda(id) {
            if (confirm('Remover venda?')) {
                vendas = vendas.filter(v => v.id !== id);
                salvarDados();
                recalcular();
            }
        }

        // ===== OR√áAMENTOS =====
        function abrirModalOrcamento() {
            document.getElementById('orcData').valueAsDate = new Date();
            document.getElementById('orcCliente').value = '';
            document.getElementById('itensOrcamento').innerHTML = '';
            adicionarItemOrcamento();
            document.getElementById('modalOrcamento').classList.add('active');
        }

        function fecharModalOrcamento() {
            document.getElementById('modalOrcamento').classList.remove('active');
        }

        function adicionarItemOrcamento() {
            const itemId = 'item_' + Date.now();
            const html = `<div style="background:#0f3460;padding:15px;border-radius:8px;margin-bottom:10px;display:grid;grid-template-columns:1fr 1fr 1fr 50px;gap:10px" id="${itemId}">
                <select class="orcProduto" style="width:100%"><option value="">-- Produto --</option>${produtos.map(p => `<option value="${p.id}">${p.nome}</option>`).join('')}</select>
                <input type="number" class="orcQtd" value="1" min="0.01" step="0.01" placeholder="Qtd">
                <input type="number" class="orcPreco" value="0" step="0.01" placeholder="Pre√ßo">
                <button class="btn danger btn-icon" onclick="document.getElementById('${itemId}').remove()">üóëÔ∏è</button>
            </div>`;
            document.getElementById('itensOrcamento').insertAdjacentHTML('beforeend', html);
        }

        function salvarOrcamento() {
            const data = document.getElementById('orcData').value;
            const cliente = document.getElementById('orcCliente').value?.trim();

            if (!data || !cliente) {
                mostraAlerta('Data e cliente obrigat√≥rios', 'error');
                return;
            }

            const itens = [];
            document.querySelectorAll('#itensOrcamento > div').forEach(div => {
                const prodId = parseInt(div.querySelector('.orcProduto').value);
                const qtd = parseFloat(div.querySelector('.orcQtd').value);
                const preco = parseFloat(div.querySelector('.orcPreco').value);
                if (prodId && qtd && preco) {
                    itens.push({ produtoId: prodId, qtd, precoUnitario: preco });
                }
            });

            if (itens.length === 0) {
                mostraAlerta('Adicione pelo menos um item', 'error');
                return;
            }

            const orc = {
                id: 'ORC-' + Date.now(),
                data,
                cliente,
                itens,
                total: itens.reduce((s, i) => s + (i.qtd * i.precoUnitario), 0),
                dataCriacao: new Date().toLocaleString('pt-BR'),
                status: 'pendente'
            };

            orcamentos.push(orc);
            salvarDados();
            mostraAlerta('Or√ßamento salvo!', 'success');
            fecharModalOrcamento();
            recalcular();
        }

        // ===== UTILIT√ÅRIOS =====
        function mostraAlerta(msg, tipo = 'info') {
            const container = document.getElementById('alertContainer');
            const alertId = 'alert_' + Date.now();
            const html = `<div id="${alertId}" class="alert ${tipo}">${msg}</div>`;
            container.insertAdjacentHTML('beforeend', html);
            setTimeout(() => document.getElementById(alertId)?.remove(), 4000);
        }

        function showTab(id) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelector(`.tab[onclick="showTab('${id}')"]`)?.classList.add('active');
            document.getElementById(id)?.classList.add('active');
        }

        function aplicarSugeridos() {
            const cfg = getConfig();
            produtos.forEach(p => {
                const d = calcDados(p, cfg);
                p.precoMin = Math.round(d.sugerido * 100) / 100;
                p.precoMax = Math.round(d.sugerido * 1.2 * 100) / 100;
            });
            salvarDados();
            mostraAlerta('Pre√ßos sugeridos aplicados!', 'success');
            recalcular();
        }

        function resetar() {
            if (confirm('Limpar todos os dados?')) {
                produtos = [];
                vendas = [];
                orcamentos = [];
                nextProdutoId = 1;
                salvarDados();
                mostraAlerta('Dados limpados', 'success');
                recalcular();
            }
        }

        // ===== GOOGLE SHEETS =====
        async function verificarStatusGoogleSheets() {
            try {
                const res = await fetch(API_URL + '/google-sheets/status');
                const data = await res.json();
                document.getElementById('gsStatus').textContent = data.configurado ? '‚úÖ Configurado' : '‚ö†Ô∏è N√£o configurado';
                document.getElementById('gsStatus').className = data.configurado ? 'sync-status ok' : 'sync-status erro';
                mostraAlerta(data.configurado ? 'Google Sheets est√° configurado!' : 'Google Sheets n√£o est√° configurado', data.configurado ? 'success' : 'warning');
            } catch (error) {
                mostraAlerta('Erro ao verificar status', 'error');
            }
        }

        async function sincronizarDe() {
            document.getElementById('syncLog').textContent = 'Sincronizando...';
            try {
                const res = await fetch(API_URL + '/google-sheets/sync-from');
                const data = await res.json();
                document.getElementById('syncLog').textContent = data.mensagem || data.erro || 'Sincroniza√ß√£o conclu√≠da';
                mostraAlerta(data.mensagem || data.erro, data.erro ? 'error' : 'success');
            } catch (error) {
                document.getElementById('syncLog').textContent = 'Erro: ' + error.message;
                mostraAlerta('Erro na sincroniza√ß√£o', 'error');
            }
        }

        async function sincronizarPara() {
            document.getElementById('syncLog').textContent = 'Exportando...';
            try {
                const res = await fetch(API_URL + '/google-sheets/sync-to');
                const data = await res.json();
                document.getElementById('syncLog').textContent = data.mensagem || data.erro || 'Exporta√ß√£o conclu√≠da';
                mostraAlerta(data.mensagem || data.erro, data.erro ? 'error' : 'success');
            } catch (error) {
                document.getElementById('syncLog').textContent = 'Erro: ' + error.message;
                mostraAlerta('Erro na exporta√ß√£o', 'error');
            }
        }

        // ===== IMPORTAR/EXPORTAR =====
        function exportarProdutosCSV() {
            let csv = 'Bitola,Di√¢metro,Comprimento,Pre√ßo Min,Pre√ßo Max,Descri√ß√£o,Aplica√ß√£o,Classe\n';
            csv += produtos.map(p => `"${p.nome}",${p.diametro},${p.comprimento},${p.precoMin},${p.precoMax},"${p.descricao}","${p.aplicacao}","${p.classe}"`).join('\n');
            downloadCSV('produtos.csv', csv);
        }

        function exportarVendasCSV() {
            let csv = 'Data,Cliente,Produto,Quantidade,Unidade,Pre√ßo Unit√°rio,Total\n';
            csv += vendas.map(v => {
                const prod = produtos.find(p => p.id === v.produtoId);
                return `${v.data},"${v.cliente}","${prod?.nome || '?'}",${v.quantidade},${v.unidade},${v.precoUnitario},${v.total}`;
            }).join('\n');
            downloadCSV('vendas.csv', csv);
        }

        function exportarOrcamentosCSV() {
            let csv = 'ID,Data,Cliente,Total,Status,Items\n';
            csv += orcamentos.map(o => `${o.id},${o.data},"${o.cliente}",${o.total},${o.status},"${o.itens.length} itens"`).join('\n');
            downloadCSV('orcamentos.csv', csv);
        }

        function exportarBackup() {
            const backup = { produtos, vendas, orcamentos, historico, config: getConfig(), exportData: new Date().toISOString() };
            downloadJSON('backup-eucalipto.json', backup);
        }

        function importarJSON() {
            const input = document.getElementById('importJSON');
            if (!input.files[0]) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    produtos = data.produtos || [];
                    vendas = data.vendas || [];
                    orcamentos = data.orcamentos || [];
                    salvarDados();
                    mostraAlerta('Backup importado com sucesso!', 'success');
                    recalcular();
                } catch (error) {
                    mostraAlerta('Erro ao importar: ' + error.message, 'error');
                }
            };
            reader.readAsText(input.files[0]);
        }

        function downloadCSV(filename, csv) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
        }

        function downloadJSON(filename, data) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
        }

        // ===== RECALCULAR =====
        function recalcular() {
            const cfg = getConfig();
            const dados_produtos = produtos.map(p => ({ ...p, ...calcDados(p, cfg) }));
            const custoSt = cfg.madeira + (cfg.tratamento * cfg.coef);
            const margemMedia = dados_produtos.length ? dados_produtos.reduce((s, p) => s + p.margemMax, 0) / dados_produtos.length : 0;
            const faturamento = vendas.reduce((s, v) => s + v.total, 0);
            const custoVendas = vendas.reduce((s, v) => s + (v.quantidade * (dados_produtos.find(p => p.id === v.produtoId)?.custoTotal || 0)), 0);
            const lucroLiq = faturamento - custoVendas;
            const vendas24h = vendas.filter(v => {
                const d = new Date(v.data);
                const agora = new Date();
                const diff = agora - d;
                return diff < 24 * 60 * 60 * 1000;
            }).reduce((s, v) => s + v.total, 0);

            document.getElementById('kpiMargem').textContent = margemMedia.toFixed(1) + '%';
            document.getElementById('kpiMargem').style.color = margemMedia >= 20 ? '#4ecca3' : margemMedia >= 10 ? '#ffcc00' : '#ff6b6b';
            document.getElementById('kpiFaturamento').textContent = fmt(faturamento);
            document.getElementById('kpiLucroLiq').textContent = fmt(lucroLiq);
            document.getElementById('kpiLucroLiq').style.color = lucroLiq >= 0 ? '#4ecca3' : '#ff6b6b';
            document.getElementById('kpiProdutos').textContent = produtos.length;
            document.getElementById('kpiVendas').textContent = vendas.length;
            document.getElementById('kpiOrcamentos').textContent = orcamentos.filter(o => o.status === 'pendente').length;
            document.getElementById('kpiAlertas').textContent = dados_produtos.filter(p => p.margemMax < 15).length;
            document.getElementById('kpiUltimas24h').textContent = fmt(vendas24h);

            renderTabelas(dados_produtos, cfg);
            renderVendas();
            renderDashboard(dados_produtos);
            renderRelatorios(dados_produtos, faturamento, custoVendas, lucroLiq);
            renderHistorico();
        }

        function renderTabelas(dados, cfg) {
            document.getElementById('tabelaProdutos').innerHTML = dados.map(p => {
                const status = p.margemMax < 0 ? 'prejuizo' : p.margemMax < 15 ? 'atencao' : 'lucro';
                return `<tr><td><button class="btn-icon danger" onclick="removerProduto(${p.id})">üóëÔ∏è</button></td><td>${p.nome}</td><td>${p.diametro}</td><td>${p.comprimento}</td><td>${(p.vol*1000).toFixed(0)}</td><td>${p.pecasSt}</td><td>${fmt(p.custoTotal)}</td><td>${p.descricao}</td><td><span class="status ${status}">${status}</span></td></tr>`;
            }).join('');

            document.getElementById('tabelaPrecos').innerHTML = dados.map(p => {
                const status = p.margemMax < 0 ? 'prejuizo' : p.margemMax < 15 ? 'atencao' : 'lucro';
                return `<tr><td>${p.nome}</td><td class="red">${fmt(p.custoTotal)}</td><td>${fmt(p.precoMin)}</td><td>${fmt(p.precoMax)}</td><td class="${p.margemMax<0?'red':'green'}">${p.margemMax.toFixed(1)}%</td><td>${fmt(p.sugerido)}</td><td><span class="status ${status}">${status}</span></td></tr>`;
            }).join('');
        }

        function renderDashboard(dados) {
            const ordenados = [...dados].sort((a, b) => b.pecasSt * b.precoMax - a.pecasSt * a.precoMax);
            document.getElementById('topVendidos').innerHTML = dados.slice(0, 5).map((p, i) => `<div style="padding:10px 0;border-bottom:1px solid #4ecca333"><strong>${p.nome}</strong> - ${p.pecasSt} p√ß/st</div>`).join('');
            document.getElementById('topLucrativos').innerHTML = ordenados.slice(0, 5).map((p, i) => `<div style="padding:10px 0;border-bottom:1px solid #4ecca333"><strong>${p.nome}</strong> - ${p.margemMax.toFixed(1)}%</div>`).join('');
        }

        function renderRelatorios(dados, fat, custo, lucro) {
            const resumo = `<div class="stats-grid">
                <div class="stat-box"><div class="stat-value">${fmt(fat)}</div><div class="stat-label">Faturamento</div></div>
                <div class="stat-box"><div class="stat-value">${fmt(custo)}</div><div class="stat-label">Custo Total</div></div>
                <div class="stat-box"><div class="stat-value">${fmt(lucro)}</div><div class="stat-label">Lucro L√≠quido</div></div>
                <div class="stat-box"><div class="stat-value">${(lucro/Math.max(fat,1)*100).toFixed(1)}%</div><div class="stat-label">Margem Total</div></div>
            </div>`;
            document.getElementById('resumoFinanceiro').innerHTML = resumo;
        }

        function renderHistorico() {
            const html = historico.slice(-20).reverse().map(h => `<div style="padding:10px;border-bottom:1px solid #4ecca333;font-size:11px">
                <strong>${h.acao}</strong> - ${h.timestamp.split('T')[1].split(':').slice(0,2).join(':')} <span style="color:#888">${h.usuario}</span>
            </div>`).join('');
            document.getElementById('listaHistorico').innerHTML = html || '<div style="padding:20px;text-align:center;color:#888">Nenhum hist√≥rico</div>';
        }

        function limparHistorico() {
            if (confirm('Limpar todo o hist√≥rico?')) {
                historico = [];
                salvarDados();
                renderHistorico();
                mostraAlerta('Hist√≥rico limpado', 'success');
            }
        }

        function atualizarPrevia(tipo) {
            const preview = document.getElementById('previewDados');
            const dados = { produtos, vendas, orcamentos, config: getConfig() };
            preview.textContent = JSON.stringify(dados[tipo], null, 2);
        }

        function removerProduto(id) {
            if (confirm('Remover produto?')) {
                produtos = produtos.filter(p => p.id !== id);
                salvarDados();
                recalcular();
            }
        }

        function salvarConfigGoogle() {
            const id = document.getElementById('configSheetsId').value;
            const key = document.getElementById('configSheetsKey').value;
            if (id && key) {
                localStorage.setItem('googleSheetsConfig', JSON.stringify({ id, key }));
                mostraAlerta('Configura√ß√£o Google Sheets salva!', 'success');
            } else {
                mostraAlerta('Preencha ID e API Key', 'error');
            }
        }

        function exportarHistorico() {
            downloadJSON('historico.json', historico);
        }

        function importarProdutosCSV() {
            mostraAlerta('Fun√ß√£o de importa√ß√£o CSV em desenvolvimento', 'info');
        }

        function exportarRelatorio() {
            mostraAlerta('Exporta√ß√£o PDF em desenvolvimento', 'info');
        }

        // Inicializar
        init();
    </script>
</body>
</html>
